# TASK-30: ç´” Database ç³»çµ±é‡æ§‹å°ˆæ¡ˆ (ä¸»ä»»å‹™)

- **å„ªå…ˆç´š**: ğŸ”´ CRITICAL
- **é è¨ˆæ™‚é–“**: 7-10 å¤©
- **é—œè¯çµ„ä»¶**: core/database/, web/, tests/, scripts/, docs/
- **çˆ¶ä»»å‹™**: ç„¡ (ä¸»è¦æ¶æ§‹é‡æ§‹)
- **å­ä»»å‹™**: TASK-30A è‡³ TASK-30M (å…±13å€‹å­ä»»å‹™)

---

## ğŸ¯ ä»»å‹™ç›®æ¨™

å°‡ Linker ç³»çµ±å¾é›™å¾Œç«¯æ¶æ§‹ï¼ˆJSON + Databaseï¼‰é‡æ§‹ç‚ºç´” Database æ¶æ§‹ï¼Œç‚ºå¾ŒçºŒçŸ¥è­˜åœ–è­œåŠŸèƒ½åšæº–å‚™ã€‚å®Œå…¨ç§»é™¤ JSON ä¾è³´å’Œé™ç´šé‚è¼¯ï¼Œå»ºç«‹çµ±ä¸€çš„è³‡æ–™åº«è³‡æ–™ç®¡ç†ç³»çµ±ã€‚

**ğŸš€ æœ€çµ‚ç›®æ¨™**: å»ºç«‹ä¸€å€‹å®Œå…¨åŸºæ–¼ PostgreSQL çš„ç©©å®šã€é«˜æ•ˆèƒ½ã€å¯æ“´å±•çš„è‹±èªå­¸ç¿’å¹³å°ï¼Œç‚ºçŸ¥è­˜åœ–è­œåŠŸèƒ½å¥ å®šå …å¯¦åŸºç¤ã€‚

## âœ… é©—æ”¶æ¨™æº– (Acceptance Criteria)

### ä¸»è¦æ¨™æº–
- [ ] ç§»é™¤æ‰€æœ‰ JSON ä¾è³´ï¼ˆ42å€‹æª”æ¡ˆä¸­çš„ç›¸é—œé‚è¼¯ï¼‰
- [ ] åˆªé™¤è¶…é 50 è™• `_legacy_manager` å¼•ç”¨
- [ ] ç§»é™¤ `DatabaseToJsonFallback` é™ç´šç­–ç•¥
- [ ] é‡æ§‹ `DatabaseAdapter` ç‚ºç´”è³‡æ–™åº«ç‰ˆæœ¬
- [ ] å»ºç«‹è³‡æ–™åº«åˆå§‹åŒ–å’Œ seed data ç³»çµ±
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéä¸”è¦†è“‹ç‡ä¿æŒ >90%

### æŠ€è¡“æ¨™æº–
- [ ] `grep -r "import json" core/` ç„¡ç›¸é—œçµæœ
- [ ] æ‰€æœ‰ web routes ä½¿ç”¨çµ±ä¸€çš„è³‡æ–™åº« API
- [ ] éŒ¯èª¤è™•ç†ä¸å†åŒ…å« JSON é™ç´šè·¯å¾‘
- [ ] é–‹ç™¼ç’°å¢ƒæ”¯æ´ä¸€éµè³‡æ–™åº«å•Ÿå‹•
- [ ] CI/CD åŒ…å«è³‡æ–™åº«æœå‹™é…ç½®

### æº–å‚™çŸ¥è­˜åœ–è­œ
- [ ] Schema æ”¯æ´é—œä¿‚å‹è³‡æ–™çµæ§‹
- [ ] é ç•™åœ–æŸ¥è©¢ API æ¥å£
- [ ] æ¨™ç±¤ç³»çµ±æº–å‚™æ“´å±•ç‚ºåœ–ç¯€é»

## ğŸ“‹ å¯¦æ–½éšæ®µèˆ‡å­ä»»å‹™åˆ†è§£

### ğŸ—‘ï¸ éšæ®µ 1: ç§»é™¤ JSON ä¾è³´ (2-3 å¤©)
**å­ä»»å‹™:**
- [x] **TASK-30B**: æ¸…ç† core/knowledge.py å’Œ JSON æ¨¡çµ„ âœ… 2025-01-15
  - é‡æ§‹ KnowledgeManager ç‚ºç´”è³‡æ–™åº«ç‰ˆæœ¬
  - å‰µå»º core/models.py è§£æ±ºå¾ªç’°å°å…¥
  - ä¿ç•™ knowledge_json_backup.py ç¶­æŒå‘å¾Œå…¼å®¹
  - ç§»é™¤ DatabaseToJsonFallback ç­–ç•¥
- [x] **TASK-30C**: é‡æ§‹ web/dependencies.py ç§»é™¤æ¢ä»¶è¼‰å…¥ âœ… 2025-01-15
  - ç§»é™¤ USE_DATABASE ç’°å¢ƒè®Šæ•¸æª¢æŸ¥
  - ç°¡åŒ–ç‚ºç´”è³‡æ–™åº«ä¾è³´æ³¨å…¥
- [x] **TASK-30D**: ç°¡åŒ– DatabaseAdapter ç§»é™¤é™ç´šé‚è¼¯ âœ… 2025-01-15
  - å‰µå»º SimplifiedDatabaseAdapter æ›¿ä»£è¤‡é›œçš„ adapter.py
  - æä¾›ç›¸åŒçš„å…¬é–‹ APIï¼Œå…§éƒ¨ä½¿ç”¨ DatabaseKnowledgeManager
  - ä¿ç•™å‘å¾Œå…¼å®¹çš„åŒæ­¥æ–¹æ³•
- [x] **TASK-30E**: ç§»é™¤ fallback_strategies JSON ç­–ç•¥ âœ… 2025-01-15
  - æ¸…ç†è¨»é‡‹å’Œæ–‡æª”
  - ç§»é™¤æœªä½¿ç”¨çš„ json import

### ğŸ› ï¸ éšæ®µ 2: éŒ¯èª¤è™•ç†é‡æ§‹ (1-2 å¤©)
**å­ä»»å‹™:**
- [ ] **TASK-30F**: å‰µå»ºæ–°çš„ DatabaseErrorHandler
- [ ] **TASK-30G**: é‡æ–°è¨­è¨ˆ fallback ç­–ç•¥

### ğŸ’¾ éšæ®µ 3: è³‡æ–™åˆå§‹åŒ– (1 å¤©)
**å­ä»»å‹™:**
- [ ] **TASK-30H**: å‰µå»º seed data å’Œåˆå§‹åŒ–ç³»çµ±

### ğŸ§ª éšæ®µ 4: æ¸¬è©¦ç’°å¢ƒé‡æ§‹ (1-2 å¤©)
**å­ä»»å‹™:**
- [ ] **TASK-30I**: é‡æ§‹æ¸¬è©¦ fixtures å’Œ conftest.py
- [ ] **TASK-30J**: æ›´æ–°æ¸¬è©¦æ¡ˆä¾‹ç§»é™¤ JSON ä¾è³´

### ğŸ”— éšæ®µ 5: çŸ¥è­˜åœ–è­œæº–å‚™ (1 å¤©)
**å­ä»»å‹™:**
- [ ] **TASK-30K**: æ“´å±• schema æ”¯æ´åœ–é—œä¿‚
- [ ] **TASK-30L**: è¨­è¨ˆåœ– API å’Œæ¨™ç±¤ç³»çµ±æ“´å±•

### âœ… éšæ®µ 6: é©—è­‰èˆ‡éƒ¨ç½² (0.5 å¤©)
**å­ä»»å‹™:**
- [ ] **TASK-30M**: å®Œæ•´ç³»çµ±é©—è­‰å’Œéƒ¨ç½²æº–å‚™

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### æ–°æ¶æ§‹æ¦‚è¦½
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Routes    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KnowledgeManagerâ”‚ â—„â”€â”€â”€ ç´”è³‡æ–™åº«ç‰ˆæœ¬ï¼Œç„¡é™ç´š
â”‚ (Database Only) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Repository     â”‚
â”‚   Layer         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚ â—„â”€â”€â”€ å”¯ä¸€è³‡æ–™ä¾†æº
â”‚ + Knowledge     â”‚
â”‚   Graph Schema  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒçµ„ä»¶è®Šæ›´

#### KnowledgeManager ç°¡åŒ–
```python
class KnowledgeManager:
    """ç´”è³‡æ–™åº«ç‰ˆæœ¬ - ç§»é™¤æ‰€æœ‰ JSON é‚è¼¯"""
    
    def __init__(self):
        self._repository = KnowledgePointRepository()
        self._cache_manager = UnifiedCacheManager()
        self._error_handler = DatabaseErrorHandler()
        # ç§»é™¤ï¼š_legacy_manager, _fallback_manager
```

#### æ–°éŒ¯èª¤è™•ç†ç­–ç•¥
```python
class DatabaseErrorHandler:
    """ç´”è³‡æ–™åº«éŒ¯èª¤è™•ç† - ç„¡ JSON é™ç´š"""
    
    def __init__(self):
        self.strategies = [
            CacheFallback(),        # ä½¿ç”¨å¿«å–è³‡æ–™
            NetworkRetryFallback(), # é‡è©¦é€£ç·š
            CircuitBreakerFallback() # ç†”æ–·ä¿è­·
            # ç§»é™¤ï¼šDatabaseToJsonFallback
        ]
```

## ğŸ”§ è³‡æ–™åˆå§‹åŒ–æ–¹æ¡ˆ

### Seed Data è¨­è¨ˆ
```sql
-- seed_data.sql
INSERT INTO knowledge_points (key_point, category, subtype, explanation, original_phrase, correction)
VALUES 
  ('ç³»çµ±åˆå§‹åŒ–ç¯„ä¾‹', 'systematic', 'grammar', 'ç³»çµ±é¦–æ¬¡å•Ÿå‹•çš„ç¯„ä¾‹çŸ¥è­˜é»', 'example error', 'example correction');

INSERT INTO tags (name, color, description) VALUES
  ('grammar', '#FF6B6B', 'æ–‡æ³•ç›¸é—œ'),
  ('vocabulary', '#4ECDC4', 'è©å½™ç›¸é—œ'),
  ('pronunciation', '#45B7D1', 'ç™¼éŸ³ç›¸é—œ');
```

### çŸ¥è­˜åœ–è­œ Schema æº–å‚™
```sql
-- knowledge_graph_relations.sql (æœªä¾†æ“´å±•)
CREATE TABLE knowledge_relationships (
    id SERIAL PRIMARY KEY,
    from_knowledge_id INTEGER REFERENCES knowledge_points(id),
    to_knowledge_id INTEGER REFERENCES knowledge_points(id),
    relationship_type VARCHAR(50) NOT NULL,
    weight DECIMAL(3,2) DEFAULT 0.5,
    confidence DECIMAL(3,2) DEFAULT 0.5,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## âš ï¸ é¢¨éšªè©•ä¼°

### é«˜é¢¨éšªé …ç›®
| é¢¨éšª | å½±éŸ¿ | ç·©è§£ç­–ç•¥ |
|------|------|----------|
| **è³‡æ–™éºå¤±** | ğŸ”´ é«˜ | å®Œæ•´å‚™ä»½ + é›™é‡é©—è­‰ |
| **å‘å¾Œä¸å…¼å®¹** | ğŸŸ¡ ä¸­ | ç‰ˆæœ¬ç®¡ç† + é·ç§»è…³æœ¬ |
| **é–‹ç™¼ç’°å¢ƒè¤‡é›œåŒ–** | ğŸŸ¡ ä¸­ | DockeråŒ– + è‡ªå‹•åŒ–è…³æœ¬ |
| **æ¸¬è©¦è¦†è“‹ä¸‹é™** | ğŸŸ  ä¸­é«˜ | é‡å¯«æ¸¬è©¦ + CIç›£æ§ |

### ç·©è§£æªæ–½
```bash
# 1. è³‡æ–™å®‰å…¨
./scripts/backup_all_data.sh
./scripts/validate_migration.sh

# 2. é–‹ç™¼ç’°å¢ƒè‡ªå‹•åŒ–
./scripts/setup_dev_db.sh
docker-compose up db

# 3. æ¸¬è©¦ä¿è­‰
pytest --cov=core --cov-fail-under=90
```

## ğŸ“Š å­ä»»å‹™åŸ·è¡Œå„ªå…ˆç´š

### ğŸš¦ ä¾è³´é—œä¿‚åœ–
```
TASK-30A (å‰ç½®) âŸ¶ TASK-30B,C,D,E (ç§»é™¤JSON) âŸ¶ TASK-30F,G (éŒ¯èª¤è™•ç†)
                                     âŸ¶ TASK-30H (åˆå§‹åŒ–)
                                             âŸ¶ TASK-30I,J (æ¸¬è©¦)
                                                     âŸ¶ TASK-30K,L (åœ–è­œ)
                                                             âŸ¶ TASK-30M (é©—è­‰)
```

### ğŸ¯ é—œéµé‡Œç¨‹ç¢‘
1. **é‡Œç¨‹ç¢‘ 1**: å®Œæˆ JSON ä¾è³´ç§»é™¤ (TASK-30A~E)
2. **é‡Œç¨‹ç¢‘ 2**: æ–°éŒ¯èª¤è™•ç†ç³»çµ±å°±ç·’ (TASK-30F~G)
3. **é‡Œç¨‹ç¢‘ 3**: ç´”è³‡æ–™åº«ç³»çµ±é‹è¡Œ (TASK-30H)
4. **é‡Œç¨‹ç¢‘ 4**: æ¸¬è©¦ç’°å¢ƒå®Œå…¨é·ç§» (TASK-30I~J)
5. **é‡Œç¨‹ç¢‘ 5**: çŸ¥è­˜åœ–è­œåŸºç¤å°±ç·’ (TASK-30K~L)
6. **é‡Œç¨‹ç¢‘ 6**: ç”Ÿç”¢éƒ¨ç½²æº–å‚™å®Œæˆ (TASK-30M)

## ğŸ“ åŸ·è¡Œç­†è¨˜

### ç•¶å‰åˆ†æçµæœ
- âœ… è­˜åˆ¥ 42 å€‹æª”æ¡ˆæ¶‰åŠ JSON ä¾è³´
- âœ… ç™¼ç¾ DatabaseAdapter ä¸­ 50+ è™•é™ç´šé‚è¼¯
- âœ… ç¢ºèªæ¨™ç±¤ç³»çµ±å¯ä½œç‚ºçŸ¥è­˜åœ–è­œåŸºç¤
- âœ… è©•ä¼°å¯¦æ–½å¯è¡Œæ€§ç‚ºé«˜
- âœ… è¨­è¨ˆç°¡åŒ–çš„ 13 å€‹å­ä»»å‹™åˆ†è§£

### éšæ®µ 1 å®Œæˆå ±å‘Š (2025-01-15)

#### TASK-30B: æ¸…ç† core/knowledge.py å’Œ JSON æ¨¡çµ„
1. é‡æ§‹ KnowledgeManager ç‚ºç´”è³‡æ–™åº«ç‰ˆæœ¬ (V3.0)
2. å‰µå»º `core/models.py` åˆ†é›¢æ•¸æ“šæ¨¡å‹ï¼Œè§£æ±ºå¾ªç’°å°å…¥
3. ä¿ç•™èˆŠç‰ˆæœ¬ç‚º `core/knowledge_json_backup.py` ç¶­æŒå‘å¾Œå…¼å®¹
4. ç§»é™¤ `DatabaseToJsonFallback` ç­–ç•¥

#### TASK-30C: é‡æ§‹ web/dependencies.py
1. ç§»é™¤ USE_DATABASE ç’°å¢ƒè®Šæ•¸æª¢æŸ¥
2. ç°¡åŒ–ç‚ºç´”è³‡æ–™åº«ä¾è³´æ³¨å…¥
3. æ›´æ–°åŒæ­¥å’Œç•°æ­¥åˆå§‹åŒ–æ–¹æ³•

#### TASK-30D: ç°¡åŒ– DatabaseAdapter
1. å‰µå»ºæ–°çš„ SimplifiedDatabaseAdapterï¼ˆ644è¡Œï¼‰æ›¿ä»£èˆŠ adapter.pyï¼ˆ1694è¡Œï¼‰
2. å‰µå»º DatabaseKnowledgeManager ç´”è³‡æ–™åº«ç®¡ç†å™¨
3. æä¾›å®Œæ•´çš„åŒæ­¥å’Œç•°æ­¥ API ç¶­æŒå‘å¾Œå…¼å®¹
4. ç§»é™¤æ‰€æœ‰ _legacy_manager å¼•ç”¨å’Œæ¢ä»¶åˆ†æ”¯

#### TASK-30E: æ¸…ç† fallback_strategies.py
1. æ›´æ–°æ¨¡çµ„æ–‡æª”ï¼Œç§»é™¤ JSON é™ç´šç›¸é—œèªªæ˜
2. åˆªé™¤æœªä½¿ç”¨çš„ json import
3. ä¿ç•™å…¶ä»–é™ç´šç­–ç•¥ï¼ˆå¿«å–ã€ç¶²è·¯é‡è©¦ã€å„ªé›…é™ç´šï¼‰

**é©—è­‰çµæœ:**
- âœ… è³‡æ–™åº«æ¨¡å¼æ­£å¸¸å•Ÿå‹•å’Œé‹è¡Œ
- âœ… æ‰€æœ‰ API åŠŸèƒ½æ¸¬è©¦é€šé
- âœ… ç„¡å¾ªç’°å°å…¥éŒ¯èª¤
- âœ… å¿«å–å’ŒéŒ¯èª¤è™•ç†æ­£å¸¸

### é‡è¦ç™¼ç¾
1. **æ·±åº¦æ•´åˆ**: JSON é‚è¼¯æ·±åº¦æ•´åˆæ–¼ 2000+ è¡Œç¨‹å¼ç¢¼ä¸­
2. **æ¨™ç±¤é—œè¯**: ç¾æœ‰ `RELATED_TAGS` å’Œ `EXCLUSIVE_TAGS` æ˜¯çŸ¥è­˜åœ–è­œé››å½¢
3. **æ¸¬è©¦ä¾è³´**: å¤§é‡æ¸¬è©¦ä¾è³´é›™ç³»çµ±åˆ‡æ›é‚è¼¯
4. **åˆå§‹åŒ–å•é¡Œ**: ç›®å‰å®Œå…¨ä¾è³´ JSON é·ç§»ä½œç‚ºè³‡æ–™ä¾†æº
5. **ä¸¦è¡Œæ©Ÿæœƒ**: éƒ¨åˆ†å­ä»»å‹™å¯ä¸¦è¡ŒåŸ·è¡Œä»¥åŠ é€Ÿé€²åº¦

### æŠ€è¡“å‚µå‹™æ¸…å–®
- DatabaseAdapter éåº¦è¤‡é›œï¼ˆ1694 è¡Œï¼‰â†’ æ‹†åˆ†ç‚ºå¤šå€‹å°ˆè²¬é¡åˆ¥
- éŒ¯èª¤è™•ç†é‚è¼¯åˆ†æ•£ â†’ çµ±ä¸€åˆ° DatabaseErrorHandler
- æ¸¬è©¦ç’°å¢ƒè¨­å®šä¸ä¸€è‡´ â†’ æ¨™æº–åŒ–æ¸¬è©¦ fixtures
- æ–‡æª”èˆ‡å¯¦éš›æ¶æ§‹è„«ç¯€ â†’ æ›´æ–°æŠ€è¡“æ–‡æª”
- ç¼ºä¹è³‡æ–™åº«æ•ˆèƒ½ç›£æ§ â†’ åŠ å…¥ metrics å’Œ logging

## ğŸ” å¯©æŸ¥æ„è¦‹ (For Reviewer)

_(ç•™ç©ºï¼Œä¾› reviewer å¡«å¯«)_

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [ç³»çµ±æ¶æ§‹åˆ†æå ±å‘Š](../docs/pure-database-analysis.md)
- [çŸ¥è­˜åœ–è­œéœ€æ±‚æ–‡æª”](../docs/knowledge-graph-requirements.md)
- [é¢¨éšªè©•ä¼°è©³ç´°å ±å‘Š](../docs/migration-risks.md)

---

## ğŸš¨ åŸ·è¡Œæ³¨æ„äº‹é …

### åˆ†æ”¯ç­–ç•¥
- **ä¸»åˆ†æ”¯**: `feature/pure-database-migration`
- **å­ä»»å‹™åˆ†æ”¯**: `task-30a-backup`, `task-30b-analysis`, ...
- **åˆä½µç­–ç•¥**: æ¯å®Œæˆä¸€å€‹éšæ®µ PR review å¾Œåˆä½µ

### å›æ»¾è¨ˆåŠƒ
- ä¿æŒå®Œæ•´çš„ JSON ç³»çµ±å‚™ä»½
- æ¯å€‹éšæ®µå®Œæˆå¾Œå‰µå»º checkpoint
- æº–å‚™å¿«é€Ÿå›æ»¾è…³æœ¬

### åœ˜éšŠå”ä½œ
- å»ºè­° 2-3 äººä¸¦è¡Œè™•ç†ä¸åŒéšæ®µ
- æ¯æ—¥ standup åŒæ­¥é€²åº¦
- é—œéµæ±ºç­–éœ€è¦ tech lead review

**âš ï¸ é‡è¦**: æ­¤ä»»å‹™ç‚ºç³»çµ±æ ¸å¿ƒæ¶æ§‹é‡æ§‹ï¼Œå½±éŸ¿ç¯„åœå»£æ³›ã€‚å‹™å¿…åš´æ ¼æŒ‰ç…§å­ä»»å‹™é †åºåŸ·è¡Œï¼Œç¢ºä¿æ¯å€‹éšæ®µå……åˆ†æ¸¬è©¦å¾Œå†é€²è¡Œä¸‹ä¸€éšæ®µã€‚