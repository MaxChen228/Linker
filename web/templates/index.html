{% extends "base.html" %}
{% block title %}Linker - è‹±æ–‡ç¿»è­¯ç·´ç¿’ç³»çµ±{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/pages/index.css" />
<link rel="stylesheet" href="/static/css/design-system/03-components/recommendation-cards.css" />
<link rel="stylesheet" href="/static/css/design-system/03-components/progress-indicators.css" />
<link rel="stylesheet" href="/static/css/components/daily-goal-widget.css" />
{% endblock %}

{% block content %}
  <!-- çµ±è¨ˆå¡ç‰‡å€ -->
  <section class="stats-grid stats-grid-3">
    <div class="stat-card" data-variant="info" data-glass="true">
      <h2>çŸ¥è­˜é»</h2>
      <p class="stat-value">{{ stats.knowledge_points }}</p>
    </div>
    <div class="stat-card" data-variant="warning" data-glass="true">
      <h2>å¾…è¤‡ç¿’</h2>
      <p class="stat-value">{{ stats.due_reviews }}</p>
    </div>
    <div class="stat-card" data-variant="accent" data-glass="true" id="daily-goal-card">
      <!-- æ¯æ—¥ç›®æ¨™çµ„ä»¶å®¹å™¨ -->
      <div id="home-daily-goal" class="daily-goal-widget card"></div>
    </div>
  </section>

  <!-- è¡Œå‹•å€å¡Š -->
  <section class="action-section">
    <div class="action-buttons">
      <a class="btn" data-variant="primary" data-size="lg" href="/practice">
        <span>é–‹å§‹ç·´ç¿’</span>
      </a>
      <a class="btn" data-variant="secondary" data-size="lg" href="/patterns">
        <span>ç€è¦½æ–‡æ³•</span>
      </a>
    </div>
    <p class="suggestion-text">
      ğŸ’¡ å»ºè­°æµç¨‹ï¼šå…ˆåœ¨ã€Œæ–‡æ³•å¥å‹ã€é¸æ“‡ç·´ç¿’ç¯„åœ â†’ åˆ°ã€Œç¿»è­¯ç·´ç¿’ã€é€²è¡Œä½œç­” â†’ æ–¼ã€ŒçŸ¥è­˜é»ã€æŸ¥çœ‹å¾…è¤‡ç¿’é‡é»
    </p>
  </section>

  <!-- è¤‡ç¿’åˆ—è¡¨å€å¡Š -->
  {% if review_items %}
  <section class="review-section">
    <div class="review-header">
      <h2 class="review-title">å¾…è¤‡ç¿’çŸ¥è­˜é»</h2>
      <a href="/practice?mode=review" class="btn review-action-btn" data-variant="accent" data-size="sm">
        é–‹å§‹è¤‡ç¿’
      </a>
    </div>
    
    <div class="review-grid">
      {% for item in review_items %}
      <div class="review-card {% if item.is_due %}is-due{% endif %}" 
           data-mastery="{{ item.mastery_level }}">
        <div class="review-card-header">
          <span class="badge" data-variant="{% if item.category_value == 'systematic' %}error{% elif item.category_value == 'isolated' %}warning{% elif item.category_value == 'enhancement' %}info{% else %}neutral{% endif %}" data-size="sm">
            {{ item.category }}
          </span>
          <div class="review-stats">
            <span class="mastery-indicator" title="æŒæ¡åº¦">
              <span class="mastery-bar">
                <span class="mastery-fill" style="--width: {{ item.mastery_level }}%"></span>
              </span>
              <span class="mastery-text">{{ item.mastery_level }}%</span>
            </span>
          </div>
        </div>
        
        <div class="review-card-content">
          <a href="/knowledge/{{ item.id }}" class="review-point-link">
            {{ item.key_point }}
          </a>
        </div>
        
        <div class="review-card-footer">
          <span class="mistake-count">
            éŒ¯èª¤ {{ item.mistake_count }} æ¬¡
          </span>
          {% if item.is_due %}
          <span class="badge" data-variant="warning" data-size="sm">å¾…è¤‡ç¿’</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    {% if review_items|length >= 10 %}
    <div class="review-more">
      <a href="/knowledge" class="btn" data-variant="ghost" data-size="sm">
        æŸ¥çœ‹å…¨éƒ¨çŸ¥è­˜é» â†’
      </a>
    </div>
    {% endif %}
  </section>
  {% else %}
  <section class="review-empty">
    <div class="empty-state">
      <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
      </svg>
      <p class="empty-message">ç›®å‰æ²’æœ‰å¾…è¤‡ç¿’çš„çŸ¥è­˜é»</p>
      <p class="empty-hint">ç¹¼çºŒç·´ç¿’ç´¯ç©æ›´å¤šçŸ¥è­˜é»å§ï¼</p>
    </div>
  </section>
  {% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/js/recommendation-card.js"></script>
<script src="/static/js/daily-goal-widget.js"></script>
<script>
    // åˆå§‹åŒ–æ¨è–¦å¡ç‰‡æµ®å‹•çµ„ä»¶
    document.addEventListener('DOMContentLoaded', () => {
        // ç­‰å¾… API endpoints åˆå§‹åŒ–å®Œæˆ
        function initializeComponents() {
            if (!window.apiEndpoints) {
                console.log('ç­‰å¾… API endpoints åˆå§‹åŒ–...');
                setTimeout(initializeComponents, 100);
                return;
            }
            
            console.log('API endpoints å·²å¯ç”¨ï¼Œåˆå§‹åŒ–çµ„ä»¶...');
            
            // åˆå§‹åŒ–æ¨è–¦å¡ç‰‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            let recommendationCard = null;
            if (window.RecommendationCard && document.getElementById('home-recommendations')) {
                try {
                    recommendationCard = new RecommendationCard('home-recommendations', {
                        position: 'bottom-right',
                        size: 'default'
                    });
                    console.log('æ¨è–¦å¡ç‰‡åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.warn('æ¨è–¦å¡ç‰‡åˆå§‹åŒ–å¤±æ•—:', error.message);
                }
            }
            
            // æº–å‚™åˆå§‹æ•¸æ“šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const initialData = {% if daily_progress %}
                {
                    status: {{ daily_progress.status|tojson }},
                    config: {{ daily_progress.config|tojson }}
                }
            {% else %}
                null
            {% endif %};
            
            // åˆå§‹åŒ–æ¯æ—¥ç›®æ¨™çµ„ä»¶
            let dailyGoalWidget = null;
            try {
                dailyGoalWidget = new DailyGoalWidget('home-daily-goal', {
                    mode: 'card',
                    autoRefresh: true,
                    refreshInterval: 120000, // 2åˆ†é˜è‡ªå‹•åˆ·æ–°
                    showInput: true,
                    initialData: initialData // å‚³éåˆå§‹æ•¸æ“š
                });
                console.log('æ¯æ—¥ç›®æ¨™çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('æ¯æ—¥ç›®æ¨™çµ„ä»¶åˆå§‹åŒ–å¤±æ•—:', error.message);
            }
            
            // å°‡çµ„ä»¶å¯¦ä¾‹ä¿å­˜åˆ°å…¨åŸŸä»¥ä¾¿å…¶ä»–è…³æœ¬ä½¿ç”¨
            if (recommendationCard) {
                window.homeRecommendationCard = recommendationCard;
            }
            if (dailyGoalWidget) {
                window.homeDailyGoal = dailyGoalWidget;
            }
        }
        
        // é–‹å§‹åˆå§‹åŒ–
        initializeComponents();
        
        // ç›£è½æ¨è–¦ç·´ç¿’äº‹ä»¶ - è·³è½‰åˆ°ç·´ç¿’é é¢
        document.addEventListener('recommendation-practice', (event) => {
            const { difficulty, mode } = event.detail;
            
            // è·³è½‰åˆ°ç·´ç¿’é é¢ä¸¦å¸¶ä¸Šåƒæ•¸
            window.location.href = `/practice?mode=${mode}&level=${difficulty}`;
        });
        
        // ç›£è½æ¯æ—¥ç›®æ¨™æ›´æ–°äº‹ä»¶
        document.addEventListener('goalUpdated', (event) => {
            const { newLimit } = event.detail;
            console.log(`æ¯æ—¥ç›®æ¨™å·²æ›´æ–°ç‚º: ${newLimit}`);
            
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æ›´å¤šèˆ‡ä¸»é ç›¸é—œçš„æ›´æ–°é‚è¼¯
        });
    });
</script>
{% endblock %}


