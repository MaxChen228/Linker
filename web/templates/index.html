{% extends "base.html" %}
{% block title %}Linker - 英文翻譯練習系統{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/pages/index.css" />
<link rel="stylesheet" href="/static/css/design-system/03-components/recommendation-cards.css" />
<link rel="stylesheet" href="/static/css/design-system/03-components/progress-indicators.css" />
<link rel="stylesheet" href="/static/css/components/daily-goal-widget.css" />
{% endblock %}

{% block content %}
  <!-- 統計卡片區 -->
  <section class="stats-grid stats-grid-3">
    <div class="stat-card" data-variant="info" data-glass="true">
      <h2>知識點</h2>
      <p class="stat-value">{{ stats.knowledge_points }}</p>
    </div>
    <div class="stat-card" data-variant="warning" data-glass="true">
      <h2>待複習</h2>
      <p class="stat-value">{{ stats.due_reviews }}</p>
    </div>
    <div class="stat-card" data-variant="accent" data-glass="true" id="daily-goal-card">
      <!-- 每日目標組件容器 -->
      <div id="home-daily-goal" class="daily-goal-widget card"></div>
    </div>
  </section>

  <!-- 行動區塊 -->
  <section class="action-section">
    <div class="action-buttons">
      <a class="btn" data-variant="primary" data-size="lg" href="/practice">
        <span>開始練習</span>
      </a>
      <a class="btn" data-variant="secondary" data-size="lg" href="/patterns">
        <span>瀏覽文法</span>
      </a>
    </div>
    <p class="suggestion-text">
      💡 建議流程：先在「文法句型」選擇練習範圍 → 到「翻譯練習」進行作答 → 於「知識點」查看待複習重點
    </p>
  </section>

  <!-- 複習列表區塊 -->
  {% if review_items %}
  <section class="review-section">
    <div class="review-header">
      <h2 class="review-title">待複習知識點</h2>
      <a href="/practice?mode=review" class="btn review-action-btn" data-variant="accent" data-size="sm">
        開始複習
      </a>
    </div>
    
    <div class="review-grid">
      {% for item in review_items %}
      <div class="review-card {% if item.is_due %}is-due{% endif %}" 
           data-mastery="{{ item.mastery_level }}">
        <div class="review-card-header">
          <span class="badge" data-variant="{% if item.category_value == 'systematic' %}error{% elif item.category_value == 'isolated' %}warning{% elif item.category_value == 'enhancement' %}info{% else %}neutral{% endif %}" data-size="sm">
            {{ item.category }}
          </span>
          <div class="review-stats">
            <span class="mastery-indicator" title="掌握度">
              <span class="mastery-bar">
                <span class="mastery-fill" style="--width: {{ item.mastery_level }}%"></span>
              </span>
              <span class="mastery-text">{{ item.mastery_level }}%</span>
            </span>
          </div>
        </div>
        
        <div class="review-card-content">
          <a href="/knowledge/{{ item.id }}" class="review-point-link">
            {{ item.key_point }}
          </a>
        </div>
        
        <div class="review-card-footer">
          <span class="mistake-count">
            錯誤 {{ item.mistake_count }} 次
          </span>
          {% if item.is_due %}
          <span class="badge" data-variant="warning" data-size="sm">待複習</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
    {% if review_items|length >= 10 %}
    <div class="review-more">
      <a href="/knowledge" class="btn" data-variant="ghost" data-size="sm">
        查看全部知識點 →
      </a>
    </div>
    {% endif %}
  </section>
  {% else %}
  <section class="review-empty">
    <div class="empty-state">
      <svg class="empty-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
      </svg>
      <p class="empty-message">目前沒有待複習的知識點</p>
      <p class="empty-hint">繼續練習累積更多知識點吧！</p>
    </div>
  </section>
  {% endif %}
{% endblock %}

{% block scripts %}
<script src="/static/js/recommendation-card.js"></script>
<script src="/static/js/daily-goal-widget.js"></script>
<script>
    // 初始化推薦卡片浮動組件
    document.addEventListener('DOMContentLoaded', () => {
        // 等待 API endpoints 初始化完成
        function initializeComponents() {
            if (!window.apiEndpoints) {
                console.log('等待 API endpoints 初始化...');
                setTimeout(initializeComponents, 100);
                return;
            }
            
            console.log('API endpoints 已可用，初始化組件...');
            
            // 初始化推薦卡片（如果可用）
            let recommendationCard = null;
            if (window.RecommendationCard && document.getElementById('home-recommendations')) {
                try {
                    recommendationCard = new RecommendationCard('home-recommendations', {
                        position: 'bottom-right',
                        size: 'default'
                    });
                    console.log('推薦卡片初始化成功');
                } catch (error) {
                    console.warn('推薦卡片初始化失敗:', error.message);
                }
            }
            
            // 準備初始數據（如果有的話）
            const initialData = {% if daily_progress %}
                {
                    status: {{ daily_progress.status|tojson }},
                    config: {{ daily_progress.config|tojson }}
                }
            {% else %}
                null
            {% endif %};
            
            // 初始化每日目標組件
            let dailyGoalWidget = null;
            try {
                dailyGoalWidget = new DailyGoalWidget('home-daily-goal', {
                    mode: 'card',
                    autoRefresh: true,
                    refreshInterval: 120000, // 2分鐘自動刷新
                    showInput: true,
                    initialData: initialData // 傳遞初始數據
                });
                console.log('每日目標組件初始化成功');
            } catch (error) {
                console.error('每日目標組件初始化失敗:', error.message);
            }
            
            // 將組件實例保存到全域以便其他腳本使用
            if (recommendationCard) {
                window.homeRecommendationCard = recommendationCard;
            }
            if (dailyGoalWidget) {
                window.homeDailyGoal = dailyGoalWidget;
            }
        }
        
        // 開始初始化
        initializeComponents();
        
        // 監聽推薦練習事件 - 跳轉到練習頁面
        document.addEventListener('recommendation-practice', (event) => {
            const { difficulty, mode } = event.detail;
            
            // 跳轉到練習頁面並帶上參數
            window.location.href = `/practice?mode=${mode}&level=${difficulty}`;
        });
        
        // 監聽每日目標更新事件
        document.addEventListener('goalUpdated', (event) => {
            const { newLimit } = event.detail;
            console.log(`每日目標已更新為: ${newLimit}`);
            
            // 可以在這裡添加更多與主頁相關的更新邏輯
        });
    });
</script>
{% endblock %}


