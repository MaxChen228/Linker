{% extends "base.html" %}
{% block title %}翻譯練習 - Linker{% endblock %}
{% block content %}
  <form method="post" class="stack" id="practiceForm">
    <div class="row">
      <label>模式</label>
      <select name="mode" id="modeSelect">
        <option value="new" {% if mode == 'new' or not mode %}selected{% endif %}>新題目</option>
        <option value="review" {% if mode == 'review' %}selected{% endif %}>複習題</option>
      </select>
      <label>長度</label>
      <select name="length" id="lengthSelect">
        <option value="short" {% if length == 'short' %}selected{% endif %}>短</option>
        <option value="medium" {% if length == 'medium' %}selected{% endif %}>中</option>
        <option value="long" {% if length == 'long' %}selected{% endif %}>長</option>
      </select>
      <label>難度</label>
      <select name="level" id="levelSelect">
        {% for lv in [1,2,3,4,5] %}
        <option value="{{ lv }}" {% if level == lv %}selected{% endif %}>{{ lv }}</option>
        {% endfor %}
      </select>
      <button type="button" class="btn outline" id="shuffleBtn">
        <span class="btn-text">{% if chinese %}換一句{% else %}出題{% endif %}</span>
      </button>
      {% if llm_debug_data and llm_debug_data.status != 'no_data' %}
      <button type="button" class="btn outline" id="debugBtn" onclick="showDebugModal()">
        <span class="btn-text">🔍 查看AI對話</span>
      </button>
      {% endif %}
    </div>

    {% if review_empty_message %}
    <!-- 複習佇列為空的提示 -->
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"></path>
      </svg>
      <h3>暫無複習項目</h3>
      <p>{{ review_empty_message }}</p>
      <p class="muted">建議切換到「新題目」模式開始練習</p>
    </div>
    {% elif chinese %}
    <label>中文句子</label>
    <textarea name="chinese" rows="3" readonly>{{ chinese }}</textarea>
    {% if hint %}
    <div class="muted">提示：{{ hint }}</div>
    {% endif %}
    {% if mode == 'review' and target_points_description %}
    <div class="muted">複習重點：{{ target_points_description }}</div>
    {% endif %}
    {% if target_points %}
    <div class="knowledge-links">
      <span class="muted">相關知識點：</span>
      {% for point in target_points %}
      <a href="/knowledge#point-{{ point.id }}" 
         target="_blank" 
         class="point-link">
        {{ point.key_point }} 
        <small>(掌握度: {{ (point.mastery_level * 100)|int }}%)</small>
      </a>
      {% if not loop.last %} | {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    <label>你的英文翻譯</label>
    <textarea name="english" rows="3" placeholder="請輸入你的英文翻譯...">{{ english or '' }}</textarea>
    {% else %}
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
      </svg>
      <h3>準備開始練習</h3>
      <p>請選擇練習模式、長度和難度，然後點擊「出題」開始練習</p>
    </div>
    {% endif %}
    <input type="hidden" name="target_point_ids" value="{{ target_point_ids | tojson if target_point_ids else '[]' }}">
    {% if chinese %}
    <div class="row">
      <button class="btn" type="submit" id="submitBtn">
        <span class="btn-text">提交</span>
      </button>
    </div>
    {% endif %}
  </form>
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-modal">
      <div class="spinner-container">
        <div class="spinner">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
      </div>
      <h3 class="loading-title" id="loadingTitle">AI 正在批改中</h3>
      <p class="loading-message" id="loadingMessage">
        正在分析你的翻譯，請稍候片刻...
      </p>
      <div class="loading-tips">
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>檢查文法結構</span>
        </div>
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>分析詞彙使用</span>
        </div>
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>生成改進建議</span>
        </div>
      </div>
    </div>
  </div>

  {% if result %}
  <section class="card">
    <h2>批改結果</h2>
    <div class="stack">
      <div>
        <div class="muted">建議：</div>
        <div>{{ result.overall_suggestion }}</div>
      </div>
      {% if result.error_analysis %}
      <div>
        <div class="muted">錯誤分析：</div>
        <ul class="list">
          {% for e in result.error_analysis %}
          <li class="item">
            <div class="error-header">
              <div class="title">{{ e.key_point_summary }}</div>
              {% set cat = e.category or '' %}
              {% set nature = e.error_nature or '' %}
              {% if cat or nature %}
                {% if cat %}
                  <span class="error-category-badge {{ cat }}">
                    {% if cat == 'systematic' %}系統性錯誤
                    {% elif cat == 'isolated' %}單一性錯誤
                    {% elif cat == 'enhancement' %}可以更好
                    {% else %}其他錯誤{% endif %}
                  </span>
                {% elif nature %}
                  {% set nature_map = {'系統性錯誤': 'systematic', '單一性錯誤': 'isolated', '可以更好': 'enhancement', '其他錯誤': 'other'} %}
                  {% set cat_class = nature_map.get(nature, 'other') %}
                  <span class="error-category-badge {{ cat_class }}">
                    {{ nature }}
                  </span>
                {% endif %}
              {% endif %}
            </div>
            {% if e.explanation %}<p class="muted">{{ e.explanation }}</p>{% endif %}
            {% if e.original_phrase or e.correction %}
            <div class="examples">
              {% if e.original_phrase %}<div class="zh">原：{{ e.original_phrase }}</div>{% endif %}
              {% if e.correction %}<div class="en">正：{{ e.correction }}</div>{% endif %}
            </div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}
  
  <!-- LLM 調試模態窗口 -->
  {% if llm_debug_data and llm_debug_data.status != 'no_data' %}
  <div id="debugModal" class="debug-modal" style="display: none;">
    <div class="debug-modal-content">
      <div class="debug-modal-header">
        <h2>🤖 AI 對話調試資訊</h2>
        <button class="close-btn" onclick="closeDebugModal()">&times;</button>
      </div>
      <div class="debug-modal-body">
        <!-- 基本資訊 -->
        <div class="debug-section">
          <h3>📊 基本資訊</h3>
          <div class="debug-info">
            <div class="info-row">
              <span class="info-label">時間戳記：</span>
              <span class="info-value">{{ llm_debug_data.timestamp }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">執行耗時：</span>
              <span class="info-value">{{ llm_debug_data.duration_ms }} ms</span>
            </div>
            <div class="info-row">
              <span class="info-label">狀態：</span>
              <span class="info-value {% if llm_debug_data.status == 'success' %}success{% else %}error{% endif %}">
                {{ llm_debug_data.status }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- 模型配置 -->
        <div class="debug-section">
          <h3>⚙️ 模型配置</h3>
          <pre class="debug-json">{{ llm_debug_data.model_config | tojson(indent=2) }}</pre>
        </div>
        
        <!-- 輸入 -->
        <div class="debug-section">
          <h3>📥 輸入 (Prompt)</h3>
          <div class="prompt-container">
            <div class="prompt-stats">
              <span>總長度：{{ llm_debug_data.input.prompt_length }} 字符</span>
              <button class="copy-btn" onclick="copyToClipboard('full-prompt')">📋 複製</button>
            </div>
            <pre id="full-prompt" class="debug-prompt">{{ llm_debug_data.input.full_prompt }}</pre>
          </div>
        </div>
        
        <!-- 輸出 -->
        <div class="debug-section">
          <h3>📤 輸出 (Response)</h3>
          <div class="response-container">
            <div class="prompt-stats">
              <span>回應長度：{{ llm_debug_data.output.response_length }} 字符</span>
              <button class="copy-btn" onclick="copyToClipboard('raw-response')">📋 複製原始回應</button>
            </div>
            
            <h4>原始回應：</h4>
            <pre id="raw-response" class="debug-json">{{ llm_debug_data.output.raw_response }}</pre>
            
            <h4>解析結果：</h4>
            <pre class="debug-json">{{ llm_debug_data.output.parsed_result | tojson(indent=2) }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <script>
    // 確保 DOM 載入完成後再綁定事件
    document.addEventListener('DOMContentLoaded', function() {
      // 出題按鈕 - 使用當前選擇的值
      const shuffleBtn = document.getElementById('shuffleBtn');
      if (shuffleBtn) {
        shuffleBtn.addEventListener('click', function() {
          const modeSelect = document.getElementById('modeSelect');
          const lengthSelect = document.getElementById('lengthSelect');
          const levelSelect = document.getElementById('levelSelect');
          
          const mode = modeSelect.value;
          const length = lengthSelect.value;
          const level = levelSelect.value;
          
          console.log('Current mode:', mode);  // 調試用
          console.log('Current length:', length);
          console.log('Current level:', level);
          
          const url = `/practice?mode=${mode}&length=${length}&level=${level}&shuffle=1`;
          console.log('Navigating to:', url);
          window.location.href = url;
        });
      }
      
      // 模式切換時重新載入頁面
      const modeSelect = document.getElementById('modeSelect');
      if (modeSelect) {
        modeSelect.addEventListener('change', function() {
          const mode = this.value;
          const length = document.getElementById('lengthSelect').value;
          const level = document.getElementById('levelSelect').value;
          window.location.href = `/practice?mode=${mode}&length=${length}&level=${level}`;
        });
      }
      
      // 長度或難度切換時也重新載入
      const lengthSelect = document.getElementById('lengthSelect');
      if (lengthSelect) {
        lengthSelect.addEventListener('change', function() {
          const mode = document.getElementById('modeSelect').value;
          const length = this.value;
          const level = document.getElementById('levelSelect').value;
          window.location.href = `/practice?mode=${mode}&length=${length}&level=${level}`;
        });
      }
      
      const levelSelect = document.getElementById('levelSelect');
      if (levelSelect) {
        levelSelect.addEventListener('change', function() {
          const mode = document.getElementById('modeSelect').value;
          const length = document.getElementById('lengthSelect').value;
          const level = this.value;
          window.location.href = `/practice?mode=${mode}&length=${length}&level=${level}`;
        });
      }
    });
    
    // 調試模態窗口函數
    function showDebugModal() {
      const modal = document.getElementById('debugModal');
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // 防止背景滾動
      }
    }
    
    function closeDebugModal() {
      const modal = document.getElementById('debugModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢復滾動
      }
    }
    
    // 點擊模態窗口外部關閉
    window.onclick = function(event) {
      const modal = document.getElementById('debugModal');
      if (event.target === modal) {
        closeDebugModal();
      }
    }
    
    // 複製到剪貼板
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const text = element.textContent;
      navigator.clipboard.writeText(text).then(() => {
        // 顯示複製成功提示
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '✅ 已複製';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('複製失敗:', err);
        alert('複製失敗，請手動選擇複製');
      });
    }
  </script>
{% endblock %}


