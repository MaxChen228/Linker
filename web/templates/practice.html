{% extends "base.html" %}
{% block title %}ç¿»è­¯ç·´ç¿’ - Linker{% endblock %}

{% block styles %}
<!-- ç·´ç¿’é é¢å°ˆå±¬æ¨£å¼ - ä½¿ç”¨æ–°è¨­è¨ˆç³»çµ± -->
<link rel="stylesheet" href="/static/css/pages/practice.css" />
<link rel="stylesheet" href="/static/css/features/review.css" />
<link rel="stylesheet" href="/static/css/features/llm-debug.css" />
{% endblock %}

{% block content %}
  <div class="practice-container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="practice-header">
      <h2>ç¿»è­¯ç·´ç¿’</h2>
      <p class="practice-subtitle">é¸æ“‡ç·´ç¿’æ¨¡å¼ï¼Œé–‹å§‹æå‡ä½ çš„è‹±æ–‡èƒ½åŠ›</p>
    </div>
    
    <!-- æ¨¡å¼é¸æ“‡ -->
    <div class="mode-selection">
      <button type="button" 
              class="btn mode-btn" 
              data-variant="card"
              data-mode="new"
              {% if mode == 'new' or not mode %}data-active="true"{% endif %}
              onclick="selectMode('new')">
        <span class="btn-title">æ–°é¡Œç›®</span>
        <span class="btn-desc">ç·´ç¿’æ–°å¥å­</span>
      </button>
      <button type="button" 
              class="btn mode-btn" 
              data-variant="card"
              data-mode="review"
              {% if mode == 'review' %}data-active="true"{% endif %}
              onclick="selectMode('review')">
        <span class="btn-title">è¤‡ç¿’é¡Œ</span>
        <span class="btn-desc">éå›ºå·²å­¸çŸ¥è­˜</span>
      </button>
    </div>
    
    <form method="post" class="stack" id="practiceForm">
      <!-- åƒæ•¸è¨­å®š -->
      <div class="params-row">
        <div class="param-group">
          <label>é•·åº¦</label>
          <select name="length" id="lengthSelect">
            <option value="short" {% if length == 'short' %}selected{% endif %}>çŸ­å¥</option>
            <option value="medium" {% if length == 'medium' %}selected{% endif %}>ä¸­å¥</option>
            <option value="long" {% if length == 'long' %}selected{% endif %}>é•·å¥</option>
          </select>
        </div>
        <div class="param-group">
          <label>é›£åº¦</label>
          <select name="level" id="levelSelect">
            {% for lv in [1,2,3,4,5] %}
            <option value="{{ lv }}" {% if level == lv %}selected{% endif %}>Level {{ lv }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="button" class="btn" data-variant="primary" data-size="lg" id="shuffleBtn">
          <span class="btn-text">{% if chinese %}æ›ä¸€å¥{% else %}é–‹å§‹å‡ºé¡Œ{% endif %}</span>
        </button>
        {% if llm_debug_data and llm_debug_data.status != 'no_data' %}
        <button type="button" class="btn" data-variant="secondary" data-size="sm" id="debugBtn" onclick="showDebugModal()">
          <span class="btn-text">ğŸ”</span>
        </button>
        {% endif %}
      </div>
      
      <!-- éš±è—çš„mode input -->
      <input type="hidden" name="mode" id="modeInput" value="{{ mode or 'new' }}">

    {% if review_empty_message %}
    <!-- è¤‡ç¿’ä½‡åˆ—ç‚ºç©ºçš„æç¤º -->
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"></path>
      </svg>
      <h3>æš«ç„¡è¤‡ç¿’é …ç›®</h3>
      <p>{{ review_empty_message }}</p>
      <p class="muted">å»ºè­°åˆ‡æ›åˆ°ã€Œæ–°é¡Œç›®ã€æ¨¡å¼é–‹å§‹ç·´ç¿’</p>
    </div>
    {% elif chinese %}
    <!-- é¡Œç›®å±•ç¤ºå€ -->
    <div class="question-section">
      <div class="card" data-type="question">
        <div class="question-label">
          <span class="label-text">ä¸­æ–‡å¥å­</span>
          {% if mode == 'review' %}
          <span class="mode-indicator review">è¤‡ç¿’æ¨¡å¼</span>
          {% endif %}
        </div>
        <div class="question-content">
          {{ chinese }}
        </div>
        <textarea name="chinese" style="display: none;" readonly>{{ chinese }}</textarea>
        
        {% if hint %}
        <div class="question-hint">
          <svg class="hint-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
          <span>æç¤ºï¼š{{ hint }}</span>
        </div>
        {% endif %}
        
        {% if mode == 'review' and target_points_description %}
        <div class="review-focus">
          <span class="focus-label">è¤‡ç¿’é‡é»ï¼š</span>
          <span class="focus-content">{{ target_points_description }}</span>
        </div>
        {% endif %}
      </div>
      
      {% if target_points %}
      <div class="knowledge-links">
        <span class="muted">ç›¸é—œçŸ¥è­˜é»ï¼š</span>
        {% for point in target_points %}
        <a href="/knowledge#point-{{ point.id }}" 
           target="_blank" 
           class="point-link">
          {{ point.key_point }} 
          <small>(æŒæ¡åº¦: {{ (point.mastery_level * 100)|int }}%)</small>
        </a>
        {% if not loop.last %} | {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    </div>
    
    <!-- ç­”æ¡ˆè¼¸å…¥å€ -->
    <div class="answer-section">
      <div class="answer-label">ä½ çš„è‹±æ–‡ç¿»è­¯</div>
      <textarea name="english" 
                rows="4" 
                class="answer-input" 
                placeholder="è«‹è¼¸å…¥ä½ çš„è‹±æ–‡ç¿»è­¯..."
                autofocus>{{ english or '' }}</textarea>
    </div>
    {% else %}
    <div class="practice-ready">
      <p>é»æ“Šã€Œé–‹å§‹å‡ºé¡Œã€æŒ‰éˆ•é–‹å§‹ç·´ç¿’</p>
    </div>
    {% endif %}
    <input type="hidden" name="target_point_ids" value="{{ target_point_ids | tojson if target_point_ids else '[]' }}">
    {% if chinese %}
    <div class="submit-section">
      <button class="btn" data-variant="primary" data-size="lg" type="submit" id="submitBtn">
        <span class="btn-text">æäº¤ç­”æ¡ˆ</span>
      </button>
    </div>
    {% endif %}
  </form>
  </div>
  
  <!-- Loading Overlay - ä½¿ç”¨æ–°è¨­è¨ˆç³»çµ± -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-modal" data-glass="true">
      <div class="spinner-container">
        <div class="spinner" data-type="multi-ring">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
      </div>
      <h3 class="loading-title" id="loadingTitle">AI æ­£åœ¨æ‰¹æ”¹ä¸­</h3>
      <p class="loading-message" id="loadingMessage">
        æ­£åœ¨åˆ†æä½ çš„ç¿»è­¯ï¼Œè«‹ç¨å€™ç‰‡åˆ»...
      </p>
      <div class="loading-tips">
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>æª¢æŸ¥æ–‡æ³•çµæ§‹</span>
        </div>
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>åˆ†æè©å½™ä½¿ç”¨</span>
        </div>
        <div class="loading-tip">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>ç”Ÿæˆæ”¹é€²å»ºè­°</span>
        </div>
      </div>
    </div>
  </div>

  {% if result %}
  <section class="card result-section" data-type="result" data-glass="true">
    <h2>æ‰¹æ”¹çµæœ</h2>
    <div class="stack">
      <div>
        <div class="muted">å»ºè­°ï¼š</div>
        <div>{{ result.overall_suggestion }}</div>
      </div>
      {% if result.error_analysis %}
      <div>
        <div class="muted">éŒ¯èª¤åˆ†æï¼š</div>
        <ul class="list">
          {% for e in result.error_analysis %}
          <li class="item">
            <div class="error-header">
              <div class="title">{{ e.key_point_summary }}</div>
              {% set cat = e.category or '' %}
              {% set nature = e.error_nature or '' %}
              {% if cat or nature %}
                {% if cat %}
                  <span class="badge error-category-badge" data-category="{{ cat }}" data-size="sm">
                    {% if cat == 'systematic' %}ç³»çµ±æ€§éŒ¯èª¤
                    {% elif cat == 'isolated' %}å–®ä¸€æ€§éŒ¯èª¤
                    {% elif cat == 'enhancement' %}å¯ä»¥æ›´å¥½
                    {% else %}å…¶ä»–éŒ¯èª¤{% endif %}
                  </span>
                {% elif nature %}
                  {% set nature_map = {'ç³»çµ±æ€§éŒ¯èª¤': 'systematic', 'å–®ä¸€æ€§éŒ¯èª¤': 'isolated', 'å¯ä»¥æ›´å¥½': 'enhancement', 'å…¶ä»–éŒ¯èª¤': 'other'} %}
                  {% set cat_class = nature_map.get(nature, 'other') %}
                  <span class="badge error-category-badge" data-category="{{ cat_class }}" data-size="sm">
                    {{ nature }}
                  </span>
                {% endif %}
              {% endif %}
            </div>
            {% if e.explanation %}<p class="muted">{{ e.explanation }}</p>{% endif %}
            {% if e.original_phrase or e.correction %}
            <div class="examples">
              {% if e.original_phrase %}<div class="zh">åŸï¼š{{ e.original_phrase }}</div>{% endif %}
              {% if e.correction %}<div class="en">æ­£ï¼š{{ e.correction }}</div>{% endif %}
            </div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}
  
  <!-- LLM èª¿è©¦æ¨¡æ…‹çª—å£ -->
  {% if llm_debug_data and llm_debug_data.status != 'no_data' %}
  <div id="debugModal" class="debug-modal" style="display: none;">
    <div class="debug-modal-content">
      <div class="debug-modal-header">
        <h2>ğŸ¤– AI å°è©±èª¿è©¦è³‡è¨Š</h2>
        <button class="btn close-btn" data-variant="icon" onclick="closeDebugModal()">&times;</button>
      </div>
      <div class="debug-modal-body">
        <!-- åŸºæœ¬è³‡è¨Š -->
        <div class="debug-section">
          <h3>ğŸ“Š åŸºæœ¬è³‡è¨Š</h3>
          <div class="debug-info">
            <div class="info-row">
              <span class="info-label">æ™‚é–“æˆ³è¨˜ï¼š</span>
              <span class="info-value">{{ llm_debug_data.timestamp }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">åŸ·è¡Œè€—æ™‚ï¼š</span>
              <span class="info-value">{{ llm_debug_data.duration_ms }} ms</span>
            </div>
            <div class="info-row">
              <span class="info-label">ç‹€æ…‹ï¼š</span>
              <span class="info-value {% if llm_debug_data.status == 'success' %}success{% else %}error{% endif %}">
                {{ llm_debug_data.status }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- æ¨¡å‹é…ç½® -->
        <div class="debug-section">
          <h3>âš™ï¸ æ¨¡å‹é…ç½®</h3>
          <pre class="debug-json">{{ llm_debug_data.model_config | tojson(indent=2) }}</pre>
        </div>
        
        <!-- è¼¸å…¥ -->
        <div class="debug-section">
          <h3>ğŸ“¥ è¼¸å…¥ (Prompt)</h3>
          <div class="prompt-container">
            <div class="prompt-stats">
              <span>ç¸½é•·åº¦ï¼š{{ llm_debug_data.input.prompt_length }} å­—ç¬¦</span>
              <button class="btn copy-btn" data-variant="gradient" data-size="sm" onclick="copyToClipboard('full-prompt')">ğŸ“‹ è¤‡è£½</button>
            </div>
            <pre id="full-prompt" class="debug-prompt">{{ llm_debug_data.input.full_prompt }}</pre>
          </div>
        </div>
        
        <!-- è¼¸å‡º -->
        <div class="debug-section">
          <h3>ğŸ“¤ è¼¸å‡º (Response)</h3>
          <div class="response-container">
            <div class="prompt-stats">
              <span>å›æ‡‰é•·åº¦ï¼š{{ llm_debug_data.output.response_length }} å­—ç¬¦</span>
              <button class="btn copy-btn" data-variant="gradient" data-size="sm" onclick="copyToClipboard('raw-response')">ğŸ“‹ è¤‡è£½åŸå§‹å›æ‡‰</button>
            </div>
            
            <h4>åŸå§‹å›æ‡‰ï¼š</h4>
            <pre id="raw-response" class="debug-json">{{ llm_debug_data.output.raw_response }}</pre>
            
            <h4>è§£æçµæœï¼š</h4>
            <pre class="debug-json">{{ llm_debug_data.output.parsed_result | tojson(indent=2) }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <script>
    // æ¨¡å¼é¸æ“‡å‡½æ•¸
    function selectMode(mode) {
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.removeAttribute('data-active');
      });
      document.querySelector(`.mode-btn[data-mode="${mode}"]`).setAttribute('data-active', 'true');
      
      // æ›´æ–°éš±è—çš„input
      document.getElementById('modeInput').value = mode;
      
      // æ›´æ–°URLä½†ä¸åˆ·æ–°é é¢ï¼ˆå¯é¸ï¼‰
      const lengthSelect = document.getElementById('lengthSelect');
      const levelSelect = document.getElementById('levelSelect');
      const newUrl = `/practice?mode=${mode}&length=${lengthSelect.value}&level=${levelSelect.value}`;
      window.history.pushState({}, '', newUrl);
    }
    
    // ç¢ºä¿ DOM è¼‰å…¥å®Œæˆå¾Œå†ç¶å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // å‡ºé¡ŒæŒ‰éˆ• - ä½¿ç”¨ç•¶å‰é¸æ“‡çš„å€¼
      const shuffleBtn = document.getElementById('shuffleBtn');
      if (shuffleBtn) {
        shuffleBtn.addEventListener('click', function() {
          const mode = document.getElementById('modeInput').value;
          const lengthSelect = document.getElementById('lengthSelect');
          const levelSelect = document.getElementById('levelSelect');
          
          const length = lengthSelect.value;
          const level = levelSelect.value;
          
          console.log('Current mode:', mode);  // èª¿è©¦ç”¨
          console.log('Current length:', length);
          console.log('Current level:', level);
          
          const url = `/practice?mode=${mode}&length=${length}&level=${level}&shuffle=1`;
          console.log('Navigating to:', url);
          window.location.href = url;
        });
      }
      
      // é•·åº¦æˆ–é›£åº¦åˆ‡æ›æ™‚ä¹Ÿé‡æ–°è¼‰å…¥
      const lengthSelect = document.getElementById('lengthSelect');
      if (lengthSelect) {
        lengthSelect.addEventListener('change', function() {
          const mode = document.getElementById('modeSelect').value;
          const length = this.value;
          const level = document.getElementById('levelSelect').value;
          window.location.href = `/practice?mode=${mode}&length=${length}&level=${level}`;
        });
      }
      
      const levelSelect = document.getElementById('levelSelect');
      if (levelSelect) {
        levelSelect.addEventListener('change', function() {
          const mode = document.getElementById('modeSelect').value;
          const length = document.getElementById('lengthSelect').value;
          const level = this.value;
          window.location.href = `/practice?mode=${mode}&length=${length}&level=${level}`;
        });
      }
      
      // è™•ç†è¡¨å–®æäº¤æ™‚é¡¯ç¤ºè¼‰å…¥è¦†è“‹å±¤
      const form = document.getElementById('practiceForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          const loadingOverlay = document.getElementById('loadingOverlay');
          if (loadingOverlay) {
            loadingOverlay.style.display = 'block';
            setTimeout(() => {
              loadingOverlay.classList.add('show');
            }, 10);
          }
        });
      }
    });
    
    // èª¿è©¦æ¨¡æ…‹çª—å£å‡½æ•¸
    function showDebugModal() {
      const modal = document.getElementById('debugModal');
      if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
      }
    }
    
    function closeDebugModal() {
      const modal = document.getElementById('debugModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // æ¢å¾©æ»¾å‹•
      }
    }
    
    // é»æ“Šæ¨¡æ…‹çª—å£å¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
      const modal = document.getElementById('debugModal');
      if (event.target === modal) {
        closeDebugModal();
      }
    }
    
    // è¤‡è£½åˆ°å‰ªè²¼æ¿
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const text = element.textContent;
      navigator.clipboard.writeText(text).then(() => {
        // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… å·²è¤‡è£½';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡è¤‡è£½');
      });
    }
  </script>
{% endblock %}


