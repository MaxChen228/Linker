{% extends "base.html" %}
{% block title %}知識點 - Linker{% endblock %}

{% block styles %}
<!-- 知識點頁面專屬樣式 - 使用新設計系統 -->
<link rel="stylesheet" href="/static/css/pages/knowledge.css" />
{% endblock %}

{% block content %}
  <!-- 批量操作工具列 -->
  <div class="batch-toolbar" data-mode="normal">
    <div class="toolbar-content">
      <!-- 進入選擇模式按鈕 -->
      <button class="btn btn-select-mode" data-variant="secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <path d="M9 11l3 3L22 4"></path>
        </svg>
        批量選擇
      </button>
      
      <!-- 選擇控制 -->
      <div class="selection-controls">
        <span class="selection-count">已選 <span>0</span> 項</span>
        <button class="btn btn-select-all" data-variant="ghost">全選</button>
        <button class="btn btn-invert" data-variant="ghost">反選</button>
        <button class="btn btn-clear" data-variant="ghost">清除</button>
      </div>
      
      <!-- 批量操作按鈕 -->
      <div class="batch-actions">
        <button class="btn btn-batch-delete" data-variant="danger" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path>
          </svg>
          批量刪除
        </button>
        <button class="btn btn-batch-export" data-variant="primary" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          導出
        </button>
        <button class="btn btn-batch-tag" data-variant="primary" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"></path>
            <line x1="7" y1="7" x2="7.01" y2="7"></line>
          </svg>
          標籤
        </button>
      </div>
    </div>
  </div>

  <!-- 頁面標題與統計 -->
  <div class="knowledge-header">
    <div class="header-top">
      <h2 class="page-title">我的知識點庫</h2>
      <div class="quick-stats">
        <div class="badge" data-variant="primary" data-size="xl">
          <span class="badge-label">總知識點</span>
          <span class="badge-value">{{ points|length }}</span>
        </div>
        <div class="badge" data-variant="warning" data-size="xl">
          <span class="badge-label">待複習</span>
          <span class="badge-value">{{ due_points|length }}</span>
        </div>
        <div class="badge" data-variant="success" data-size="xl">
          <span class="badge-label">平均掌握度</span>
          <span class="badge-value">{{ "%.0f"|format(stats.avg_mastery * 100) }}%</span>
        </div>
        <a href="/knowledge/trash" class="badge link-plain" data-variant="neutral" data-size="xl">
          <span class="badge-label">回收站</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18"></path>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path>
          </svg>
        </a>
      </div>
    </div>
    
    <!-- 搜尋欄 -->
    <div class="search-bar">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input type="text" 
             id="knowledge-search" 
             placeholder="搜尋知識點..." 
             autocomplete="off" />
      <span class="search-hint">即時搜尋</span>
    </div>
  </div>
  
  <!-- 改進的篩選區域 -->
  <div class="filter-container">
    <!-- 錯誤類別篩選 -->
    <div class="filter-section">
      <h3 class="filter-title">錯誤類別</h3>
      <div class="filter-tabs">
        <button class="btn active" data-variant="filter-tab" data-filter-type="category" data-filter-value="">
          全部
          <span class="btn-count">{{ points|length }}</span>
        </button>
        {% for cat in categories %}
          <button class="btn" data-variant="filter-tab" data-filter-type="category" data-filter-value="{{ cat }}">
            {{ cat }}
            <span class="btn-count">{{ category_counts[cat] }}</span>
          </button>
        {% endfor %}
      </div>
    </div>
    
    <!-- 掌握度篩選 -->
    <div class="filter-section">
      <h3 class="filter-title">掌握程度</h3>
      <div class="filter-pills">
        <button class="btn active" data-variant="filter-pill" data-filter-type="mastery" data-filter-value="">
          全部
        </button>
        <button class="btn" data-variant="filter-pill" data-filter-type="mastery" data-filter-value="low">
          <span class="mastery-dot low"></span>
          低 (&lt;30%)
        </button>
        <button class="btn" data-variant="filter-pill" data-filter-type="mastery" data-filter-value="medium">
          <span class="mastery-dot medium"></span>
          中 (30-70%)
        </button>
        <button class="btn" data-variant="filter-pill" data-filter-type="mastery" data-filter-value="high">
          <span class="mastery-dot high"></span>
          高 (&gt;70%)
        </button>
      </div>
    </div>
  </div>
  
  <!-- 知識點網格 - 緊湊卡片佈局 -->
  <div class="knowledge-grid">
    <!-- 系統性錯誤群組 -->
    {% for group in knowledge_groups %}
    <div class="knowledge-group-compact" data-category="系統性錯誤" data-mastery-level="{{ group.avg_mastery|default(0) }}" data-search-text="{{ (group.name|default(''))|lower }}" data-item-id="group-{{ loop.index }}">
      <input type="checkbox" class="selection-checkbox" />
      <div class="group-header-compact">
        <h3 class="group-title-compact">{{ group.name }}</h3>
        <div class="group-badges">
          <span class="badge" data-variant="error">系統性</span>
          <span class="badge" data-variant="neutral">{{ group.count }}個</span>
        </div>
      </div>
      <div class="group-points-compact">
        {% for point in group.points[:3] %}
        <a href="/knowledge/{{ point.id }}" class="point-item-compact" data-mastery-level="{{ point.mastery_level }}">
          <span class="point-title-compact">{{ point.key_point[:30] }}{% if point.key_point|length > 30 %}...{% endif %}</span>
          <div class="point-stats-compact">
            <span class="mastery-indicator" style="--width: {{ (point.mastery_level * 100)|int }}%"></span>
            <span class="mistake-count">{{ point.mistake_count }}</span>
          </div>
        </a>
        {% endfor %}
        {% if group.points|length > 3 %}
        <div class="group-more">還有 {{ group.points|length - 3 }} 個知識點...</div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    
    <!-- 單一性錯誤 -->
    {% for point in isolated_points %}
    <div class="knowledge-card-compact" 
       data-category="單一性錯誤" 
       data-mastery-level="{{ point.mastery_level }}"
       data-search-text="{{ (point.key_point|default(''))|lower }} {{ (point.explanation|default(''))|lower }}"
       data-item-id="{{ point.id }}">
      <input type="checkbox" class="selection-checkbox" />
      <a href="/knowledge/{{ point.id }}" class="card-link">
      <div class="card-header-compact">
        <div class="card-title-compact">
          <span class="error-text">{{ point.original_phrase[:20] }}{% if point.original_phrase|length > 20 %}...{% endif %}</span>
          <span class="arrow">→</span>
          <span class="correct-text">{{ point.correction[:20] }}{% if point.correction|length > 20 %}...{% endif %}</span>
        </div>
        <span class="badge" data-variant="warning">單一</span>
      </div>
      <div class="card-body-compact">
        <div class="mastery-bar-compact">
          <div class="mastery-fill" style="--width: {{ (point.mastery_level * 100)|int }}%"></div>
        </div>
        <div class="card-stats-compact">
          <span class="stat">錯誤 {{ point.mistake_count }}</span>
          <span class="stat">{{ (point.mastery_level * 100)|int }}%</span>
        </div>
      </div>
      </a>
    </div>
    {% endfor %}
    
    <!-- 可以更好 -->
    {% for point in enhancement_points %}
    <div class="knowledge-card-compact" 
       data-category="可以更好" 
       data-mastery-level="{{ point.mastery_level }}"
       data-search-text="{{ (point.key_point|default(''))|lower }} {{ (point.explanation|default(''))|lower }}"
       data-item-id="{{ point.id }}">
      <input type="checkbox" class="selection-checkbox" />
      <a href="/knowledge/{{ point.id }}" class="card-link">
      <div class="card-header-compact">
        <div class="card-title-compact">
          <span class="error-text">{{ point.original_phrase[:20] }}{% if point.original_phrase|length > 20 %}...{% endif %}</span>
          <span class="arrow">→</span>
          <span class="correct-text">{{ point.correction[:20] }}{% if point.correction|length > 20 %}...{% endif %}</span>
        </div>
        <span class="badge" data-variant="info">改進</span>
      </div>
      <div class="card-body-compact">
        <div class="mastery-bar-compact">
          <div class="mastery-fill" style="--width: {{ (point.mastery_level * 100)|int }}%"></div>
        </div>
        <div class="card-stats-compact">
          <span class="stat">錯誤 {{ point.mistake_count }}</span>
          <span class="stat">{{ (point.mastery_level * 100)|int }}%</span>
        </div>
      </div>
      </a>
    </div>
    {% endfor %}
    
    <!-- 其他錯誤 -->
    {% for point in other_points %}
    <div class="knowledge-card-compact" 
       data-category="其他錯誤" 
       data-mastery-level="{{ point.mastery_level }}"
       data-search-text="{{ (point.key_point|default(''))|lower }} {{ (point.explanation|default(''))|lower }}"
       data-item-id="{{ point.id }}">
      <input type="checkbox" class="selection-checkbox" />
      <a href="/knowledge/{{ point.id }}" class="card-link">
      <div class="card-header-compact">
        <div class="card-title-compact">
          <span class="error-text">{{ point.original_phrase[:20] }}{% if point.original_phrase|length > 20 %}...{% endif %}</span>
          <span class="arrow">→</span>
          <span class="correct-text">{{ point.correction[:20] }}{% if point.correction|length > 20 %}...{% endif %}</span>
        </div>
        <span class="badge" data-variant="neutral">其他</span>
      </div>
      <div class="card-body-compact">
        <div class="mastery-bar-compact">
          <div class="mastery-fill" style="--width: {{ (point.mastery_level * 100)|int }}%"></div>
        </div>
        <div class="card-stats-compact">
          <span class="stat">錯誤 {{ point.mistake_count }}</span>
          <span class="stat">{{ (point.mastery_level * 100)|int }}%</span>
        </div>
      </div>
      </a>
    </div>
    {% endfor %}
  </div>
  
  <!-- 無結果提示 -->
  <div class="no-results hidden" id="no-knowledge-results">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
      <path d="M11 8v3m0 4h.01"></path>
    </svg>
    <p>沒有找到符合條件的知識點</p>
  </div>
{% endblock %}

{% block scripts %}
<!-- 引入選擇管理器和批量操作 -->
<script src="/static/js/selection-manager.js"></script>
<script type="module" src="/static/js/batch-operations.js"></script>
<script>
// 篩選功能 - 支援組合篩選
let activeFilters = {
  category: '',
  mastery: '',
  search: ''
};

function applyFilters() {
  console.log('[知識點篩選] 套用篩選條件:', activeFilters);
  const items = document.querySelectorAll('.knowledge-card-compact, .knowledge-group-compact');
  console.log('[知識點篩選] 找到', items.length, '個項目');
  let hasResults = false;
  
  items.forEach(item => {
    let show = true;
    
    // 檢查類別篩選
    if (activeFilters.category) {
      show = show && item.dataset.category === activeFilters.category;
    }
    
    // 檢查掌握度篩選
    if (activeFilters.mastery) {
      const mastery = parseFloat(item.dataset.masteryLevel || 0);
      if (activeFilters.mastery === 'low') {
        show = show && mastery < 0.3;
      } else if (activeFilters.mastery === 'medium') {
        show = show && mastery >= 0.3 && mastery < 0.7;
      } else if (activeFilters.mastery === 'high') {
        show = show && mastery >= 0.7;
      }
    }
    
    // 檢查搜尋條件
    if (activeFilters.search) {
      const searchText = (item.dataset.searchText || '').toLowerCase();
      const searchTerm = activeFilters.search.toLowerCase();
      show = show && searchText.includes(searchTerm);
    }
    
    item.style.display = show ? '' : 'none';
    if (show) hasResults = true;
  });
  
  const noResultsEl = document.querySelector('.no-results');
  if (noResultsEl) {
    noResultsEl.style.display = hasResults ? 'none' : 'flex';
  }
}

// 初始化選擇管理器和批量操作
let selectionManager = null;
let batchOperations = null;

// 等待所有模組加載完成後初始化
function initializeManagers() {
  if (typeof SelectionManager !== 'undefined' && typeof BatchOperations !== 'undefined') {
    console.log('[知識點頁面] 初始化選擇管理器和批量操作');
    
    // 初始化選擇管理器
    selectionManager = new SelectionManager();
    
    // 初始化批量操作
    batchOperations = new BatchOperations(selectionManager);
    
    setupEventListeners();
  } else {
    // 如果模組還沒加載完成，100ms後重試
    setTimeout(initializeManagers, 100);
  }
}

function setupEventListeners() {
  // 監聽選擇變化
  selectionManager.on('selectionchange', (data) => {
    console.log('[選擇變化]', data);
    
    // 可以在這裡添加批量操作的邏輯
    if (data.count > 0) {
      // 啟用批量操作按鈕
    }
  });
  
  // 綁定批量操作按鈕
  const batchDeleteBtn = document.querySelector('.btn-batch-delete');
  if (batchDeleteBtn) {
    batchDeleteBtn.addEventListener('click', async () => {
      const selected = selectionManager.getSelectedIds();
      if (selected.length === 0) return;
      
      // 使用批量操作處理器
      batchOperations.batchDelete();
    });
  }
  
  const batchExportBtn = document.querySelector('.btn-batch-export');
  if (batchExportBtn) {
    batchExportBtn.addEventListener('click', async () => {
      const selected = selectionManager.getSelectedIds();
      if (selected.length === 0) return;
      
      // 使用批量操作處理器
      batchOperations.batchExport();
    });
  }
  
  const batchTagBtn = document.querySelector('.btn-batch-tag');
  if (batchTagBtn) {
    batchTagBtn.addEventListener('click', async () => {
      const selected = selectionManager.getSelectedIds();
      if (selected.length === 0) return;
      
      // 使用批量操作處理器
      batchOperations.batchTag();
    });
  }
  
  // 綁定搜尋功能
  const searchInput = document.getElementById('knowledge-search');
  if (searchInput) {
    console.log('[知識點頁面] 綁定搜尋框事件');
    searchInput.addEventListener('input', function(e) {
      activeFilters.search = e.target.value;
      applyFilters();
    });
  }

  // 綁定篩選按鈕功能
  const filterButtons = document.querySelectorAll('[data-filter-type]');
  console.log('[知識點頁面] 找到篩選按鈕:', filterButtons.length);
  
  filterButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // 防止按鈕預設行為
      
      const filterType = this.dataset.filterType;
      const filterValue = this.dataset.filterValue;
      
      console.log('[知識點頁面] 點擊篩選:', filterType, '=', filterValue);
      
      // 更新按鈕狀態
      document.querySelectorAll(`[data-filter-type="${filterType}"]`).forEach(b => {
        b.classList.remove('active');
      });
      this.classList.add('active');
      
      // 更新活躍篩選條件
      activeFilters[filterType] = filterValue;
      
      // 應用所有篩選條件
      applyFilters();
    });
  });
  
  // 初始化篩選
  applyFilters();
}

// 頁面載入完成後開始初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('[知識點頁面] DOM 載入完成，開始初始化');
  initializeManagers();
});
</script>
{% endblock %}