{% extends "base.html" %}
{% block title %}çŸ¥è­˜é» - Linker{% endblock %}

{% block styles %}
<!-- çŸ¥è­˜é»é é¢å°ˆå±¬æ¨£å¼ -->
<link rel="stylesheet" href="/static/css/pages/knowledge.css" />
<link rel="stylesheet" href="/static/css/features/review.css" />
{% endblock %}

{% block content %}
  <!-- é é¢æ¨™é¡Œèˆ‡çµ±è¨ˆ -->
  <div class="knowledge-header">
    <div class="header-top">
      <h2 class="page-title">æˆ‘çš„çŸ¥è­˜é»åº«</h2>
      <div class="quick-stats">
        <div class="badge stat-badge" data-variant="primary" data-size="xl">
          <span class="badge-label">ç¸½çŸ¥è­˜é»</span>
          <span class="badge-value">{{ points|length }}</span>
        </div>
        <div class="badge stat-badge" data-variant="warning" data-size="xl">
          <span class="badge-label">å¾…è¤‡ç¿’</span>
          <span class="badge-value">{{ due_points|length }}</span>
        </div>
        <div class="badge stat-badge" data-variant="success" data-size="xl">
          <span class="badge-label">å¹³å‡æŒæ¡åº¦</span>
          <span class="badge-value">{{ "%.0f"|format(stats.avg_mastery * 100) }}%</span>
        </div>
      </div>
    </div>
    
    <!-- æœå°‹æ¬„ -->
    <div class="search-bar">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input type="text" 
             id="knowledgeSearch" 
             placeholder="æœå°‹çŸ¥è­˜é»..." 
             autocomplete="off" />
      <span class="search-hint">å³æ™‚æœå°‹</span>
    </div>
  </div>
  
  <!-- è¤‡ç¿’ä½‡åˆ— -->
  {% if review_queue %}
    <div class="review-queue-section">
      <div class="queue-header">
        <h3 class="queue-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          è¤‡ç¿’ä½‡åˆ—
        </h3>
        <a href="/practice?mode=review&shuffle=1" class="btn" data-variant="primary" data-size="sm">
          é–‹å§‹è¤‡ç¿’ç·´ç¿’
        </a>
      </div>
      <div class="queue-content">
        <div class="queue-items">
          {% for point in review_queue[:5] %}
          <div class="queue-item {% if point.next_review <= now %}due{% endif %}">
            <div class="queue-item-info">
              <span class="queue-item-title">{{ point.key_point }}</span>
              <span class="queue-item-stats">
                éŒ¯èª¤{{ point.mistake_count }}æ¬¡ Â· æŒæ¡åº¦{{ "%.0f"|format(point.mastery_level * 100) }}%
              </span>
            </div>
            <div class="queue-item-badge">
              {% if point.category.value == 'isolated' %}
                <span class="badge isolated">å–®ä¸€</span>
              {% elif point.category.value == 'enhancement' %}
                <span class="badge enhancement">æ”¹é€²</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% if review_queue|length > 5 %}
        <div class="queue-more">
          é‚„æœ‰ {{ review_queue|length - 5 }} å€‹çŸ¥è­˜é»å¯è¤‡ç¿’
        </div>
        {% endif %}
      </div>
    </div>
  {% endif %}
  
  <!-- æ”¹é€²çš„ç¯©é¸å€åŸŸ -->
  <div class="filter-container">
    <!-- éŒ¯èª¤é¡åˆ¥ç¯©é¸ -->
    <div class="filter-section">
      <h3 class="filter-title">éŒ¯èª¤é¡åˆ¥</h3>
      <div class="filter-tabs">
        <button class="btn filter-tab active" data-variant="tab" data-filter-type="category" data-filter-value="">
          å…¨éƒ¨
          <span class="btn-count">{{ points|length }}</span>
        </button>
        {% for cat in categories %}
          <button class="btn filter-tab" data-variant="tab" data-filter-type="category" data-filter-value="{{ cat }}">
            {{ cat }}
            <span class="btn-count">{{ category_counts.get(cat, 0) }}</span>
          </button>
        {% endfor %}
      </div>
    </div>
    
    <!-- æŒæ¡ç¨‹åº¦ç¯©é¸ -->
    <div class="filter-section">
      <h3 class="filter-title">æŒæ¡ç¨‹åº¦</h3>
      <div class="filter-tabs">
        <button class="btn filter-tab active" data-variant="tab" data-filter-type="mastery" data-filter-value="">
          å…¨éƒ¨
        </button>
        <button class="btn filter-tab" data-variant="tab" data-filter-type="mastery" data-filter-value="low">
          <span class="mastery-dot low"></span>
          éœ€åŠ å¼· (&lt;30%)
        </button>
        <button class="btn filter-tab" data-variant="tab" data-filter-type="mastery" data-filter-value="medium">
          <span class="mastery-dot medium"></span>
          é€²æ­¥ä¸­ (30-70%)
        </button>
        <button class="btn filter-tab" data-variant="tab" data-filter-type="mastery" data-filter-value="high">
          <span class="mastery-dot high"></span>
          å·²æŒæ¡ (&gt;70%)
        </button>
      </div>
    </div>
  </div>
  
  <!-- çŸ¥è­˜é»å…§å®¹å€ -->
  <div class="knowledge-content">
    
    <!-- ç³»çµ±æ€§éŒ¯èª¤ç¾¤çµ„ -->
    {% if knowledge_groups %}
    <section class="knowledge-section">
      <h3 class="section-title">
        <span class="section-icon systematic">ğŸ“š</span>
        ç³»çµ±æ€§éŒ¯èª¤ï¼ˆ{{ knowledge_groups|length }} å€‹è¦å‰‡ç¾¤çµ„ï¼‰
      </h3>
      <div class="knowledge-groups">
        {% for group in knowledge_groups %}
        <div class="card" data-type="group" data-mastery="{% if group.avg_mastery < 0.3 %}low{% elif group.avg_mastery < 0.7 %}medium{% else %}high{% endif %}" data-group-name="{{ group.name }}">
          <div class="group-header" onclick="toggleGroup(this)">
            <div class="group-info">
              <h4 class="group-title">{{ group.name }}</h4>
              <div class="group-stats">
                <span class="stat-item">
                  <span class="stat-icon">ğŸ“</span>
                  {{ group.count }} å€‹å¯¦ä¾‹
                </span>
                <span class="stat-item">
                  <span class="stat-icon">âŒ</span>
                  ç¸½è¨ˆ {{ group.total_mistakes }} æ¬¡éŒ¯èª¤
                </span>
                <span class="stat-item">
                  <span class="stat-icon">ğŸ“Š</span>
                  æŒæ¡åº¦ {{ "%.0f"|format(group.avg_mastery * 100) }}%
                </span>
              </div>
            </div>
            <div class="group-progress">
              <div class="progress-ring">
                <svg width="60" height="60">
                  <circle cx="30" cy="30" r="25" stroke-width="4" fill="none" stroke="#e5e7eb" />
                  <circle cx="30" cy="30" r="25" stroke-width="4" fill="none" 
                          stroke="{% if group.avg_mastery < 0.3 %}#ef4444{% elif group.avg_mastery < 0.7 %}#f59e0b{% else %}#10b981{% endif %}"
                          stroke-dasharray="{{ group.avg_mastery * 157 }} 157"
                          stroke-dashoffset="0"
                          transform="rotate(-90 30 30)" />
                </svg>
                <span class="progress-text">{{ "%.0f"|format(group.avg_mastery * 100) }}%</span>
              </div>
            </div>
            <button class="btn group-toggle" data-variant="icon" data-size="sm">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>
          
          <div class="group-content">
            <div class="group-instances">
              {% for point in group.points %}
              <div class="card instance-card" data-type="instance" data-size="sm" id="point-{{ point.id }}">
                <div class="instance-header">
                  <span class="instance-title">{{ point.key_point }}</span>
                  <span class="instance-mastery">{{ "%.0f"|format(point.mastery_level * 100) }}%</span>
                </div>
                {% if point.explanation %}
                <p class="instance-explanation">{{ point.explanation }}</p>
                {% endif %}
                {% if point.original_phrase or point.correction %}
                <div class="instance-comparison">
                  {% if point.original_phrase %}
                  <div class="compare-item error">âŒ {{ point.original_phrase }}</div>
                  {% endif %}
                  {% if point.correction %}
                  <div class="compare-item correct">âœ… {{ point.correction }}</div>
                  {% endif %}
                </div>
                {% endif %}
                
                {% if point.examples and point.examples|length > 0 %}
                <div class="instance-examples">
                  <div class="examples-label">å®Œæ•´å¥å­å°ç…§ï¼š</div>
                  {% set latest_example = point.examples[-1] %}
                  <div class="full-sentence-compare">
                    <div class="sentence-item">
                      <span class="sentence-label">ä¸­æ–‡åŸå¥ï¼š</span>
                      <span class="sentence-text">{{ latest_example.chinese }}</span>
                    </div>
                    <div class="sentence-item error">
                      <span class="sentence-label">ä½ çš„ç¿»è­¯ï¼š</span>
                      <span class="sentence-text">{{ latest_example.user_answer }}</span>
                    </div>
                    <div class="sentence-item correct">
                      <span class="sentence-label">æ­£ç¢ºç¿»è­¯ï¼š</span>
                      <span class="sentence-text">{{ latest_example.correct }}</span>
                    </div>
                  </div>
                </div>
                {% endif %}
                
                <div class="instance-stats">
                  <span>éŒ¯èª¤ {{ point.mistake_count }} æ¬¡</span>
                  <span>æ­£ç¢º {{ point.correct_count }} æ¬¡</span>
                  <span>ä¸‹æ¬¡è¤‡ç¿’ï¼š{{ point.next_review[:10] }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
    
    <!-- å–®ä¸€æ€§éŒ¯èª¤ -->
    {% if isolated_points %}
    <section class="knowledge-section">
      <h3 class="section-title">
        <span class="section-icon isolated">ğŸ“</span>
        å–®ä¸€æ€§éŒ¯èª¤ï¼ˆ{{ isolated_points|length }} å€‹ï¼‰
      </h3>
      <div class="cards-grid knowledge-cards">
        {% for point in isolated_points %}
        <div class="card knowledge-single-card" data-type="knowledge" data-interactive="true" data-decorated="true" data-mastery="{% if point.mastery_level < 0.3 %}low{% elif point.mastery_level < 0.7 %}medium{% else %}high{% endif %}" id="point-{{ point.id }}" data-category="å–®ä¸€æ€§éŒ¯èª¤">
          <div class="card-header">
            <h4 class="card-title">{{ point.key_point }}</h4>
            <div class="badge mastery-badge" data-mastery="{% if point.mastery_level < 0.3 %}low{% elif point.mastery_level < 0.7 %}medium{% else %}high{% endif %}">
              {{ "%.0f"|format(point.mastery_level * 100) }}%
            </div>
          </div>
          {% if point.explanation %}
          <p class="card-explanation">{{ point.explanation }}</p>
          {% endif %}
          {% if point.original_phrase or point.correction %}
          <div class="card-comparison">
            {% if point.original_phrase %}
            <div class="compare-item error">âŒ {{ point.original_phrase }}</div>
            {% endif %}
            {% if point.correction %}
            <div class="compare-item correct">âœ… {{ point.correction }}</div>
            {% endif %}
          </div>
          {% endif %}
          
          {% if point.examples and point.examples|length > 0 %}
          <div class="card-examples">
            <div class="examples-label">å®Œæ•´å¥å­ï¼š</div>
            {% set latest_example = point.examples[-1] %}
            <div class="full-sentence">
              <div class="sentence-zh">{{ latest_example.chinese }}</div>
              <div class="sentence-en error">âŒ {{ latest_example.user_answer }}</div>
              <div class="sentence-en correct">âœ… {{ latest_example.correct }}</div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
    
    <!-- å¯ä»¥æ›´å¥½ -->
    {% if enhancement_points %}
    <section class="knowledge-section">
      <h3 class="section-title">
        <span class="section-icon enhancement">âœ¨</span>
        å¯ä»¥æ›´å¥½ï¼ˆ{{ enhancement_points|length }} å€‹ï¼‰
      </h3>
      <div class="cards-grid knowledge-cards">
        {% for point in enhancement_points %}
        <div class="card knowledge-single-card enhancement" data-type="knowledge" data-interactive="true" data-decorated="true" data-mastery="{% if point.mastery_level < 0.3 %}low{% elif point.mastery_level < 0.7 %}medium{% else %}high{% endif %}" id="point-{{ point.id }}" data-category="å¯ä»¥æ›´å¥½">
          <div class="card-header">
            <h4 class="card-title">{{ point.key_point }}</h4>
            <div class="badge mastery-badge" data-mastery="high">
              {{ "%.0f"|format(point.mastery_level * 100) }}%
            </div>
          </div>
          {% if point.explanation %}
          <p class="card-explanation">{{ point.explanation }}</p>
          {% endif %}
          {% if point.original_phrase or point.correction %}
          <div class="card-comparison">
            {% if point.original_phrase %}
            <div class="compare-item original">åŸï¼š{{ point.original_phrase }}</div>
            {% endif %}
            {% if point.correction %}
            <div class="compare-item improved">âœ¨ {{ point.correction }}</div>
            {% endif %}
          </div>
          {% endif %}
          
          {% if point.examples and point.examples|length > 0 %}
          <div class="card-examples">
            <div class="examples-label">å®Œæ•´å¥å­ï¼š</div>
            {% set latest_example = point.examples[-1] %}
            <div class="full-sentence">
              <div class="sentence-zh">{{ latest_example.chinese }}</div>
              <div class="sentence-en original">åŸï¼š{{ latest_example.user_answer }}</div>
              <div class="sentence-en improved">âœ¨ {{ latest_example.correct }}</div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
    
    <!-- å…¶ä»–éŒ¯èª¤ -->
    {% if other_points %}
    <section class="knowledge-section">
      <h3 class="section-title">
        <span class="section-icon other">ğŸ“Œ</span>
        å…¶ä»–éŒ¯èª¤ï¼ˆ{{ other_points|length }} å€‹ï¼‰
      </h3>
      <div class="cards-grid knowledge-cards">
        {% for point in other_points %}
        <div class="card knowledge-single-card" data-type="knowledge" data-interactive="true" data-decorated="true" data-mastery="{% if point.mastery_level < 0.3 %}low{% elif point.mastery_level < 0.7 %}medium{% else %}high{% endif %}" data-category="å…¶ä»–éŒ¯èª¤">
          <div class="card-header">
            <h4 class="card-title">{{ point.key_point }}</h4>
            <div class="badge mastery-badge" data-mastery="{% if point.mastery_level < 0.3 %}low{% elif point.mastery_level < 0.7 %}medium{% else %}high{% endif %}">
              {{ "%.0f"|format(point.mastery_level * 100) }}%
            </div>
          </div>
          {% if point.explanation %}
          <p class="card-explanation">{{ point.explanation }}</p>
          {% endif %}
          
          {% if point.original_phrase or point.correction %}
          <div class="card-comparison">
            {% if point.original_phrase %}
            <div class="compare-item error">âŒ {{ point.original_phrase }}</div>
            {% endif %}
            {% if point.correction %}
            <div class="compare-item correct">âœ… {{ point.correction }}</div>
            {% endif %}
          </div>
          {% endif %}
          
          {% if point.examples and point.examples|length > 0 %}
          <div class="card-examples">
            <div class="examples-label">å®Œæ•´å¥å­ï¼š</div>
            {% set latest_example = point.examples[-1] %}
            <div class="full-sentence">
              <div class="sentence-zh">{{ latest_example.chinese }}</div>
              <div class="sentence-en error">âŒ {{ latest_example.user_answer }}</div>
              <div class="sentence-en correct">âœ… {{ latest_example.correct }}</div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
    
  </div>
  
  <!-- ç„¡çµæœæç¤º -->
  <div class="no-results" id="noKnowledgeResults" style="display: none;">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
    </svg>
    <h3>æ²’æœ‰æ‰¾åˆ°çŸ¥è­˜é»</h3>
    <p>è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–é–‹å§‹ç·´ç¿’ç´¯ç©æ–°çš„çŸ¥è­˜é»</p>
    <a href="/practice" class="btn" data-variant="primary">é–‹å§‹ç·´ç¿’</a>
  </div>
  
  <script>
    function toggleGroup(header) {
      const card = header.closest('.card[data-type="group"]');
      const content = card.querySelector('.group-content');
      const toggle = header.querySelector('.group-toggle svg');
      
      if (content.classList.contains('expanded')) {
        // æ”¶èµ·
        content.classList.remove('expanded');
        header.classList.remove('expanded');
        content.style.display = 'none';
      } else {
        // å±•é–‹
        content.classList.add('expanded');
        header.classList.add('expanded');
        content.style.display = 'block';
      }
      
      // æ—‹è½‰ç®­é ­
      if (toggle) {
        toggle.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)';
      }
    }
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ‰€æœ‰ group-content ç‚ºéš±è—
    document.addEventListener('DOMContentLoaded', function() {
      const groupContents = document.querySelectorAll('.group-content');
      groupContents.forEach(content => {
        if (!content.classList.contains('expanded')) {
          content.style.display = 'none';
        }
      });
    });
    
    // è™•ç†URL hashå®šä½åˆ°ç‰¹å®šçŸ¥è­˜é»
    window.addEventListener('load', function() {
      const hash = window.location.hash;
      if (hash && hash.startsWith('#point-')) {
        const element = document.querySelector(hash);
        if (element) {
          // å¦‚æœçŸ¥è­˜é»åœ¨æŠ˜ç–Šçš„ç¾¤çµ„ä¸­ï¼Œå…ˆå±•é–‹ç¾¤çµ„
          const groupContent = element.closest('.group-content');
          if (groupContent && !groupContent.classList.contains('expanded')) {
            const groupSummary = groupContent.previousElementSibling;
            toggleGroup(groupSummary);
          }
          
          // æ»¾å‹•åˆ°å…ƒç´ 
          setTimeout(() => {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // é«˜äº®é¡¯ç¤º
            element.style.transition = 'background-color 0.3s';
            element.style.backgroundColor = '#fef3c7';
            setTimeout(() => {
              element.style.backgroundColor = '';
            }, 3000);
          }, 500);
        }
      }
    });
  </script>
{% endblock %}