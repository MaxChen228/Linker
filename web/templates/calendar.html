{% extends "base.html" %}

{% block title %}å­¸ç¿’æ—¥æ›† - Linker{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="calendar-header">
        <h1 class="calendar-title">å­¸ç¿’æ—¥æ›†</h1>
        <div class="calendar-subtitle">è¿½è¹¤ä½ çš„å­¸ç¿’é€²åº¦ï¼Œä¿æŒæ¯æ—¥å­¸ç¿’ç¿’æ…£</div>
    </div>

    <!-- æœˆä»½å°èˆª -->
    <div class="month-navigation">
        <a href="/calendar?year={{ prev_year }}&month={{ prev_month }}" class="nav-button prev">
            <span class="nav-icon">â†</span>
        </a>
        
        <div class="month-display">
            <h2 class="month-title">{{ month_data.year }}å¹´ {{ month_data.month }}æœˆ</h2>
            <a href="/calendar" class="today-link">è¿”å›ä»Šå¤©</a>
        </div>
        
        <a href="/calendar?year={{ next_year }}&month={{ next_month }}" class="nav-button next">
            <span class="nav-icon">â†’</span>
        </a>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="calendar-stats">
        <div class="stat-card">
            <div class="stat-label">æœ¬æœˆå¾…è¤‡ç¿’</div>
            <div class="stat-value">{{ month_data.stats.total_reviews_pending }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">å·²å®Œæˆè¤‡ç¿’</div>
            <div class="stat-value success">{{ month_data.stats.total_completed }}</div>
        </div>
        <div class="stat-card" id="streak-card">
            <div class="stat-label">é€£çºŒå­¸ç¿’</div>
            <div class="stat-value accent">-</div>
        </div>
    </div>

    <!-- æ—¥æ›†ç¶²æ ¼ -->
    <div class="calendar-grid">
        <!-- æ˜ŸæœŸæ¨™é¡Œ -->
        <div class="weekday-headers">
            <div class="weekday-header">ä¸€</div>
            <div class="weekday-header">äºŒ</div>
            <div class="weekday-header">ä¸‰</div>
            <div class="weekday-header">å››</div>
            <div class="weekday-header">äº”</div>
            <div class="weekday-header">å…­</div>
            <div class="weekday-header">æ—¥</div>
        </div>

        <!-- æ—¥æœŸæ ¼å­ -->
        <div class="calendar-days">
            {% for week in month_data.weeks %}
                {% for day in week %}
                    {% if day %}
                    <div class="calendar-day 
                        {% if day.is_today %}today{% endif %}
                        {% if day.is_past %}past{% endif %}
                        {% if day.is_future %}future{% endif %}
                        intensity-{{ day.study_intensity }}"
                        data-date="{{ day.date_str }}"
                        onclick="showDayDetails('{{ day.date_str }}')">
                        
                        <div class="day-number">{{ day.date }}</div>
                        
                        {% if day.reviews_pending > 0 %}
                        <div class="day-badge pending">
                            <span class="badge-icon">ğŸ“š</span>
                            <span class="badge-count">{{ day.reviews_pending }}</span>
                        </div>
                        {% endif %}
                        
                        {% if day.reviews_completed > 0 %}
                        <div class="day-badge completed">
                            <span class="badge-icon">âœ“</span>
                            <span class="badge-count">{{ day.reviews_completed }}</span>
                        </div>
                        {% endif %}
                        
                        {% if day.new_practices > 0 %}
                        <div class="day-badge practice">
                            <span class="badge-icon">âœï¸</span>
                            <span class="badge-count">{{ day.new_practices }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="calendar-day empty"></div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- åœ–ä¾‹èªªæ˜ -->
    <div class="calendar-legend">
        <div class="legend-title">åœ–ä¾‹èªªæ˜</div>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-color intensity-none"></span>
                <span class="legend-label">ç„¡æ´»å‹•</span>
            </div>
            <div class="legend-item">
                <span class="legend-color intensity-light"></span>
                <span class="legend-label">è¼•åº¦å­¸ç¿’ (1-2é¡Œ)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color intensity-medium"></span>
                <span class="legend-label">ä¸­åº¦å­¸ç¿’ (3-5é¡Œ)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color intensity-heavy"></span>
                <span class="legend-label">é‡åº¦å­¸ç¿’ (6+é¡Œ)</span>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥æœŸè©³æƒ…æ¨¡æ…‹æ¡† -->
<div id="dayModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeDayModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalDate" class="modal-title"></h3>
            <button class="modal-close" onclick="closeDayModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="dayDetailsContent">
                <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/pages/calendar.css">
{% endblock %}

{% block scripts %}
<script>
// è¼‰å…¥é€£çºŒå­¸ç¿’çµ±è¨ˆ
async function loadStreakStats() {
    try {
        const response = await fetch('/calendar/api/stats/streak');
        const data = await response.json();
        
        const streakCard = document.getElementById('streak-card');
        if (streakCard) {
            streakCard.querySelector('.stat-value').textContent = 
                data.current_streak > 0 ? `${data.current_streak} å¤©` : '0 å¤©';
            
            // æ·»åŠ ç«ç„°æ•ˆæœ
            if (data.current_streak >= 7) {
                streakCard.classList.add('on-fire');
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥é€£çºŒçµ±è¨ˆå¤±æ•—:', error);
    }
}

// é¡¯ç¤ºæ—¥æœŸè©³æƒ…
async function showDayDetails(dateStr) {
    const modal = document.getElementById('dayModal');
    const modalDate = document.getElementById('modalDate');
    const content = document.getElementById('dayDetailsContent');
    
    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
    const date = new Date(dateStr);
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    modalDate.textContent = date.toLocaleDateString('zh-TW', options);
    
    // è¼‰å…¥è©³ç´°è³‡æ–™
    try {
        const response = await fetch(`/calendar/api/day/${dateStr}`);
        const data = await response.json();
        
        let html = '';
        
        // å¾…è¤‡ç¿’é …ç›®
        if (data.due_reviews && data.due_reviews.length > 0) {
            html += '<div class="day-section">';
            html += '<h4 class="section-title">ğŸ” å¾…è¤‡ç¿’çŸ¥è­˜é»</h4>';
            html += '<div class="review-list">';
            
            for (const review of data.due_reviews) {
                const isCompleted = data.completed_reviews.includes(review.id);
                html += `
                    <div class="review-item ${isCompleted ? 'completed' : ''}" data-id="${review.id}">
                        <div class="review-content">
                            <div class="review-title">${review.key_point}</div>
                            <div class="review-detail">
                                <span class="error-text">${review.original_phrase}</span>
                                <span class="arrow">â†’</span>
                                <span class="correct-text">${review.correction}</span>
                            </div>
                            <div class="review-meta">
                                <span class="mastery-badge" data-level="${getMasteryLevel(review.mastery_level)}">
                                    æŒæ¡åº¦ ${Math.round(review.mastery_level * 100)}%
                                </span>
                                <span class="category-badge" data-category="${review.category}">
                                    ${getCategoryName(review.category)}
                                </span>
                            </div>
                        </div>
                        <div class="review-actions">
                            ${isCompleted ? 
                                '<span class="status-icon completed">âœ“</span>' :
                                `<a href="/practice?mode=review&point_id=${review.id}" class="btn-review">é–‹å§‹è¤‡ç¿’</a>`
                            }
                        </div>
                    </div>
                `;
            }
            
            html += '</div></div>';
        }
        
        // å­¸ç¿’çµ±è¨ˆ
        if (data.new_practices > 0 || data.study_minutes > 0) {
            html += '<div class="day-section">';
            html += '<h4 class="section-title">ğŸ“Š ä»Šæ—¥å­¸ç¿’çµ±è¨ˆ</h4>';
            html += '<div class="day-stats">';
            
            if (data.new_practices > 0) {
                html += `<div class="stat-item">æ–°ç·´ç¿’: ${data.new_practices} é¡Œ</div>`;
            }
            if (data.total_mistakes > 0) {
                html += `<div class="stat-item">éŒ¯èª¤æ•¸: ${data.total_mistakes} å€‹</div>`;
            }
            if (data.study_minutes > 0) {
                html += `<div class="stat-item">å­¸ç¿’æ™‚é•·: ${data.study_minutes} åˆ†é˜</div>`;
            }
            if (data.mastery_improvement > 0) {
                html += `<div class="stat-item">æŒæ¡åº¦æå‡: +${(data.mastery_improvement * 100).toFixed(1)}%</div>`;
            }
            
            html += '</div></div>';
        }
        
        // å¦‚æœæ²’æœ‰ä»»ä½•è³‡æ–™
        if (!html) {
            html = '<div class="empty-state">é€™ä¸€å¤©æ²’æœ‰å­¸ç¿’è¨˜éŒ„</div>';
        }
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
        
    } catch (error) {
        console.error('è¼‰å…¥æ—¥æœŸè©³æƒ…å¤±æ•—:', error);
        content.innerHTML = '<div class="error-state">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
        modal.classList.remove('hidden');
    }
}

// é—œé–‰æ¨¡æ…‹æ¡†
function closeDayModal() {
    document.getElementById('dayModal').classList.add('hidden');
}

// ç²å–æŒæ¡åº¦ç­‰ç´š
function getMasteryLevel(mastery) {
    if (mastery < 0.3) return 'low';
    if (mastery < 0.7) return 'medium';
    return 'high';
}

// ç²å–åˆ†é¡åç¨±
function getCategoryName(category) {
    const names = {
        'systematic': 'ç³»çµ±æ€§éŒ¯èª¤',
        'isolated': 'å–®ä¸€æ€§éŒ¯èª¤',
        'enhancement': 'å¯ä»¥æ›´å¥½',
        'other': 'å…¶ä»–éŒ¯èª¤'
    };
    return names[category] || category;
}

// ESC éµé—œé–‰æ¨¡æ…‹æ¡†
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDayModal();
    }
});

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadStreakStats();
});
</script>
{% endblock %}