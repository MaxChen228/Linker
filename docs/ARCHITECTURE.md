# 系統架構文檔

## 概述

Linker CLI 採用模組化架構設計，將功能分離到不同的模組中，確保高內聚低耦合。系統主要分為以下幾個層次：

```
┌─────────────────────────────────────────────┐
│            使用者介面層 (CLI)                │
│              linker_cli.py                   │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│             業務邏輯層                       │
│  ┌─────────────────────────────────────┐    │
│  │    翻譯練習    │    知識點管理        │    │
│  │  practice_*()  │  KnowledgeManager   │    │
│  └─────────────────────────────────────┘    │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│              核心服務層                       │
│  ┌──────────┬──────────┬───────────────┐    │
│  │ AI服務   │錯誤分類  │  日誌系統      │    │
│  │AIService │Classifier│   Logger       │    │
│  └──────────┴──────────┴───────────────┘    │
└─────────────────┬───────────────────────────┘
                  │
┌─────────────────▼───────────────────────────┐
│            基礎設施層                         │
│  ┌──────────┬──────────┬───────────────┐    │
│  │ 配置管理 │異常處理  │  數據存儲      │    │
│  │ Settings │Exception │   JSON Files   │    │
│  └──────────┴──────────┴───────────────┘    │
└─────────────────────────────────────────────┘
```

## 模組詳解

### 1. 使用者介面層

#### linker_cli.py
- **職責**：處理用戶輸入，顯示選單，協調各模組
- **主要功能**：
  - `main()` - 主程式入口
  - `show_menu()` - 顯示主選單
  - `practice_translation()` - 翻譯練習入口
  - `display_feedback()` - 顯示反饋
  - `manage_knowledge()` - 知識點管理入口

### 2. 業務邏輯層

#### 翻譯練習模組
- **職責**：管理翻譯練習流程
- **關鍵函數**：
  - `select_difficulty()` - 難度選擇
  - `get_practice_sentence()` - 獲取練習句子
  - `process_translation()` - 處理翻譯
  - `update_knowledge_points()` - 更新知識點

#### 知識點管理（core/knowledge.py）
- **職責**：知識點的 CRUD 操作和掌握度管理
- **類別**：`KnowledgeManager`
- **主要方法**：
  - `add_knowledge_point()` - 新增知識點
  - `update_mastery()` - 更新掌握度
  - `get_review_items()` - 獲取需要複習的項目
  - `export_statistics()` - 匯出統計數據

### 3. 核心服務層

#### AI 服務（core/ai_service.py）
- **職責**：與 Gemini API 交互
- **類別**：`AIService`
- **主要方法**：
  - `check_translation()` - 檢查翻譯
  - `analyze_errors()` - 分析錯誤
  - `generate_examples()` - 生成例句
- **特性**：
  - 請求緩存
  - 重試機制
  - 錯誤處理

#### 錯誤分類器（core/error_classifier.py）
- **職責**：智能分類錯誤類型
- **類別**：`ErrorClassifier`
- **分類邏輯**：
  ```python
  系統性錯誤 → 文法規則類
  單一性錯誤 → 詞彙、搭配類
  可以更好 → 表達優化類
  其他錯誤 → 理解、遺漏類
  ```

#### 日誌系統（core/logger.py）
- **職責**：統一日誌記錄和管理
- **類別**：`Logger`
- **功能**：
  - 多級別日誌（DEBUG, INFO, WARNING, ERROR, CRITICAL）
  - 多輸出目標（控制台、文件）
  - 多種格式（純文本、JSON）
  - 性能監控

### 4. 基礎設施層

#### 配置管理（settings.py）
- **職責**：集中管理所有配置
- **配置類別**：
  - `DisplaySettings` - 顯示配置
  - `LearningSettings` - 學習參數
  - `CacheSettings` - 緩存配置
  - `APISettings` - API 設定
  - `LogSettings` - 日誌配置
  - `DataSettings` - 數據路徑

#### 異常處理（core/exceptions.py）
- **職責**：統一異常定義和處理
- **異常層級**：
  ```
  LinkerException
  ├── APIException
  │   └── GeminiAPIException
  ├── DataException
  ├── ValidationException
  ├── ConfigException
  ├── FileOperationException
  ├── ParseException
  └── UserInputException
  ```

#### 數據存儲
- **格式**：JSON 文件
- **文件**：
  - `knowledge.json` - 知識點數據
  - `practice_log.json` - 練習記錄
  - `examples.json` - 例句庫
  - `grammar.json` - 文法規則

## 數據流

### 翻譯練習流程

```
用戶輸入翻譯
    ↓
AI Service 檢查
    ↓
錯誤分類器分析
    ↓
知識點管理器更新
    ↓
數據持久化到 JSON
    ↓
顯示反饋給用戶
```

### 知識點更新流程

```
識別錯誤類型
    ↓
查找或創建知識點
    ↓
計算掌握度變化
    ↓
更新複習排程
    ↓
保存到數據文件
```

## 設計模式

### 1. 單例模式（Singleton）
- **應用**：Settings 配置管理
- **目的**：確保全局只有一個配置實例

### 2. 工廠模式（Factory）
- **應用**：Logger 創建
- **目的**：根據配置創建不同類型的日誌器

### 3. 策略模式（Strategy）
- **應用**：錯誤分類策略
- **目的**：根據不同錯誤類型採用不同處理策略

### 4. 裝飾器模式（Decorator）
- **應用**：函數日誌記錄
- **目的**：無侵入式添加日誌功能

## 性能考量

### 緩存策略
- API 響應緩存（TTL: 5分鐘）
- 知識點內存緩存
- 例句預載入

### 優化措施
- 延遲載入大型數據文件
- 批量寫入減少 I/O
- 異步日誌寫入（計劃中）

## 安全考量

### API 金鑰保護
- 環境變數存儲
- 不在代碼中硬編碼
- 日誌中遮蔽敏感信息

### 數據驗證
- 用戶輸入驗證
- JSON 格式檢查
- 異常邊界處理

## 擴展性設計

### 插件化架構（計劃中）
- 支援自定義錯誤分類器
- 可替換的 AI 服務提供者
- 自定義數據存儲後端

### 介面設計
- 明確的模組介面
- 依賴注入支援
- 易於測試的設計

## 部署架構

### 單機部署
```
linker-cli/
├── 程式文件
├── 配置文件
├── 數據文件
└── 日誌文件
```

### Docker 部署（計劃中）
```dockerfile
FROM python:3.8-slim
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "linker_cli.py"]
```

## 監控和維護

### 日誌監控
- 錯誤率追蹤
- API 調用統計
- 性能指標記錄

### 健康檢查
- API 連接檢查
- 數據文件完整性
- 配置驗證

## 未來規劃

### 短期（v2.1）
- 批量練習模式
- 報告匯出功能
- 性能優化

### 中期（v2.2）
- Web 介面
- 多用戶支援
- 雲端同步

### 長期（v3.0）
- 微服務架構
- 多語言支援
- AI 模型本地化