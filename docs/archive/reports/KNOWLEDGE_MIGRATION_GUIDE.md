# 知識點重複問題解決方案

## 問題描述

原有系統存在知識點混合問題：
- 不同的具體錯誤被歸類到同一個抽象知識點下
- 例如「單字拼寫錯誤」知識點包含 `irrevertable → irreversible` 和 `phonee → phone` 兩個不相關的錯誤
- 導致複習時出現不相關的練習題

## 解決方案

### 1. 核心改進

- **知識點唯一性**：基於 `(key_point, original_phrase, correction)` 三元組識別
- **例句來源分離**：
  - 原始錯誤句子（每個知識點只有一個）
  - 複習練習句子（可以有多個）
- **練習模式區分**：
  - 新題模式：發現新錯誤時創建新知識點
  - 複習模式：針對特定知識點練習，更新掌握度

### 2. AI 提示改進

AI 現在會生成更具體的知識點描述：
- 舊格式：`"單字拼寫錯誤"`
- 新格式：`"單字拼寫錯誤: irrevertable"`

### 3. 資料結構升級

```json
{
  "id": 5,
  "key_point": "單字拼寫錯誤: irrevertable",
  "original_error": {
    "chinese_sentence": "若政府再不採取行動...",
    "user_answer": "...irrevertable impact...",
    "correct_answer": "...irreversible impact...",
    "timestamp": "2025-08-11T12:40:23"
  },
  "review_examples": [
    {
      "chinese_sentence": "這個決定造成了無法挽回的後果",
      "user_answer": "...irrevertable consequences...",
      "correct_answer": "...irreversible consequences...",
      "timestamp": "2025-08-12T14:20:15",
      "is_correct": false
    }
  ]
}
```

## 遷移步驟

### 1. 執行數據遷移腳本

```bash
# 在專案根目錄下執行
python scripts/migrate_knowledge_points.py
```

遷移腳本會：
- 自動創建備份檔案
- 分析重複的知識點
- 拆分混合的知識點為獨立知識點
- 轉換資料格式到版本 3.0

### 2. 驗證遷移結果

遷移完成後：
1. 檢查 `data/backups/` 目錄確保備份存在
2. 重新啟動系統：`uvicorn web.main:app --reload --port 8000`
3. 訪問 `/knowledge` 頁面檢查知識點是否正確分離
4. 測試複習功能確保邏輯正確

## 功能驗證

### 新題模式測試
1. 進入練習頁面，選擇「新題」模式
2. 故意犯錯（如拼寫錯誤）
3. 檢查是否創建了新的知識點

### 複習模式測試
1. 進入練習頁面，選擇「複習」模式
2. 系統應該基於現有知識點生成練習題
3. 答錯時應該添加到該知識點的複習例句
4. 答對時應該更新掌握度

## 注意事項

1. **備份重要性**：遷移前會自動創建備份，但建議手動備份 `data/` 目錄
2. **版本兼容性**：系統同時支援新舊資料格式，確保平滑升級
3. **AI 服務**：新的 AI prompt 會生成更具體的錯誤描述
4. **前端更新**：知識點頁面會顯示更詳細的錯誤信息

## 故障排除

### 遷移失敗
- 檢查 Python 環境和依賴
- 查看 `logs/` 目錄的錯誤記錄
- 從備份檔案恢復原始資料

### 系統啟動問題
- 確保新的資料結構正確載入
- 檢查 `knowledge.json` 的格式是否為版本 3.0
- 查看伺服器日誌確認錯誤原因

### 功能異常
- 驗證知識點的唯一性識別是否正常
- 檢查練習模式參數是否正確傳遞
- 確認 AI 服務返回的錯誤分析格式

## 技術細節

### 修改的檔案
- `core/knowledge.py` - 知識點管理邏輯
- `core/ai_service.py` - AI 提示優化
- `web/main.py` - 練習模式區分
- `scripts/migrate_knowledge_points.py` - 遷移腳本

### 資料版本歷史
- v1.0: 原始版本（陣列格式）
- v2.0: 結構化版本（包含 version 欄位）
- v3.0: 新知識點結構（分離原始錯誤和複習例句）

---

這個解決方案從根本上解決了知識點重複的問題，確保每個具體錯誤都有獨立的學習軌跡，提升了學習效果和系統的邏輯正確性。